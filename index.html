<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src * data: blob: filesystem: about: ws: wss: 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; media-src *; connect-src *;">
    <title>K‚ÄôLe√±os Sabor 100% Valluno - Pedidos</title>
    
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #ffffff;
            /* Limita el desplazamiento horizontal innecesario */
            overflow: hidden;	
        }
        .view {
            height: 92vh;
            overflow-y: auto; 
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .hidden-view {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
            position: absolute;
            width: 100%;
        }
        .category-scroll::-webkit-scrollbar {
            display: none;
        }
        .category-scroll {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="max-w-lg mx-auto bg-white antialiased">

    <div id="app-container" class="pb-28">

        <div id="menu-view" class="view">
            <header class="sticky top-0 bg-white z-10 border-b-2 border-black p-3 flex items-center justify-between space-x-3">
                <div class="flex items-center space-x-3">
                    <img src="https://static.wixstatic.com/media/777c76_3f3b35a51e8841f78a4f9e65d8cc7604~mv2.png/v1/fill/w_818,h_544,al_c,q_90,usm_0.66_1.00_0.01,enc_avif,quality_auto/777c76_3f3b35a51e8841f78a4f9e65d8cc7604~mv2.png" alt="Logo K'Le√±os" class="w-14 h-auto">
                    <div>
                        <h1 id="restaurant-name-header" class="text-lg font-black text-red-600"></h1>
                        <p class="text-xs font-medium text-gray-700">Promos y 2x1 todos los d√≠as</p>
                    </div>
                </div>
                <button id="location-btn" class="flex items-center space-x-1 bg-gray-100 border border-gray-300 rounded-full py-1 px-3 transform hover:scale-105 transition-transform">
                    <span class="text-xl">üìç</span>
                    <span class="text-xs font-bold">Sedes</span>
                </button>
            </header>

            <div id="status-box-container" class="p-3">
                <div id="operating-status-box" class="p-3 rounded-lg shadow-md flex items-center space-x-3 transition-all duration-300">
                    <span id="status-icon" class="text-2xl"></span>
                    <div>
                        <p id="status-message-main" class="font-bold text-sm"></p>
                        <p id="status-message-secondary" class="text-xs"></p>
                    </div>
                </div>
            </div>
            <section id="filters-section" class="p-3 bg-white">
                <div class="flex overflow-x-auto category-scroll space-x-2 mb-3">
                    <button data-category="all" class="category-btn flex-shrink-0 bg-red-600 text-white font-bold py-1.5 px-3 rounded-full shadow-md text-sm transform hover:scale-105 transition-transform duration-200">Todos</button>
                    <button data-category="Promos" class="category-btn flex-shrink-0 bg-red-600 text-white font-bold py-1.5 px-3 rounded-full shadow-md text-sm transform hover:scale-105 transition-transform duration-200">Promos</button>
                    <button data-category="Hamburguesas" class="category-btn flex-shrink-0 bg-red-600 text-white font-bold py-1.5 px-3 rounded-full shadow-md text-sm transform hover:scale-105 transition-transform duration-200">Hamburguesas</button>
                    <button data-category="Perros Calientes" class="category-btn flex-shrink-0 bg-red-600 text-white font-bold py-1.5 px-3 rounded-full shadow-md text-sm transform hover:scale-105 transition-transform duration-200">Perros</button>
                    <button data-category="Asados" class="category-btn flex-shrink-0 bg-red-600 text-white font-bold py-1.5 px-3 rounded-full shadow-md text-sm transform hover:scale-105 transition-transform duration-200">Asados</button>
                    <button data-category="Fritos" class="category-btn flex-shrink-0 bg-red-600 text-white font-bold py-1.5 px-3 rounded-full shadow-md text-sm transform hover:scale-105 transition-transform duration-200">Fritos</button>
                    <button data-category="Parrillada" class="category-btn flex-shrink-0 bg-red-600 text-white font-bold py-1.5 px-3 rounded-full shadow-md text-sm transform hover:scale-105 transition-transform duration-200">Parrillada</button>
                    <button data-category="Adiciones" class="category-btn flex-shrink-0 bg-red-600 text-white font-bold py-1.5 px-3 rounded-full shadow-md text-sm transform hover:scale-105 transition-transform duration-200">Adiciones</button>
                </div>
                <div id="social-links-container" class="flex justify-center items-center space-x-5"></div>
            </section>

            <main id="product-list" class="p-3 grid grid-cols-1 gap-3"></main>

            <section class="p-6 text-center bg-gray-50 border-t-2 border-b-2 border-red-600 border-l-2 border-r-2 mx-3 rounded-xl shadow-inner my-5">
                <h2 class="text-xl font-black text-red-600 mb-2">üî• ¬°Siempre con Sabor Valluno! üî•</h2>
                <p class="text-gray-700 text-base font-medium">Estamos trabajando para a√±adir m√°s delicias a nuestro men√∫.</p>
                <p class="text-sm text-gray-500 mt-1">¬°Vuelve pronto para probar nuestras nuevas sorpresas!</p>
            </section>
        </div>

        <div id="cart-view" class="view hidden-view">
            <header class="p-3 border-b-2 border-black"><h1 class="text-xl font-black text-red-600 text-center">üõí Tu Pedido</h1></header>
            <section id="cart-items-container" class="p-3 space-y-3"></section>
            <div id="empty-cart-message" class="p-8 text-center text-gray-500 hidden"><p class="text-base">Tu carrito est√° vac√≠o.</p><p class="text-sm">¬°Agrega algo delicioso del men√∫!</p></div>
            <section class="px-3 py-2"><div class="flex justify-between items-center text-lg font-bold border-t-2 border-black pt-3"><span>TOTAL:</span><span id="cart-total" class="text-red-600">$0.00</span></div></section>
            
            <section class="p-3">
                <h2 class="text-lg font-bold text-red-600 mb-2">üë§ Tus Datos</h2>
                <div class="space-y-2">
                    <input type="text" id="customer-name-input" placeholder="Tu nombre completo" class="w-full p-2.5 border-2 border-gray-300 rounded-lg text-sm focus:border-yellow-400 focus:ring-yellow-400" required>
                    <input type="tel" id="customer-phone-input" placeholder="Tu n√∫mero de WhatsApp (ej: 310...)" class="w-full p-2.5 border-2 border-gray-300 rounded-lg text-sm focus:border-yellow-400 focus:ring-yellow-400" required>
                </div>
            </section>
            
            <section id="scheduling-section" class="p-3 border-t-2 border-gray-100">
                <h2 class="text-lg font-bold text-red-600 mb-2">‚è∞ ¬øCu√°ndo lo quieres?</h2>
                <div class="space-y-3">
                    <div id="delivery-time-now-option" class="time-option w-full text-left p-3 border-2 border-gray-300 rounded-lg flex items-center space-x-3 transition-all cursor-pointer border-yellow-400 border-4">
                        <span class="text-xl">üöÄ</span><span class="font-semibold text-sm">Lo quiero AHORA (Entrega tan pronto como sea posible)</span>
                    </div>
                    <div id="delivery-time-schedule-option" class="time-option w-full text-left p-3 border-2 border-gray-300 rounded-lg flex items-center space-x-3 transition-all cursor-pointer">
                        <span class="text-xl">üóìÔ∏è</span><span class="font-semibold text-sm">Programar para despu√©s</span>
                    </div>
                    
                    <div id="schedule-input-container" class="pl-4 hidden space-y-2">
                        <input type="date" id="scheduled-date-input" class="w-full p-2.5 border-2 border-gray-300 rounded-lg text-sm focus:border-yellow-400 focus:ring-yellow-400">
                        <input type="time" id="scheduled-time-input" class="w-full p-2.5 border-2 border-gray-300 rounded-lg text-sm focus:border-yellow-400 focus:ring-yellow-400">
                        <p id="schedule-warning" class="text-xs text-red-500 mt-1 hidden">‚ö†Ô∏è La hora seleccionada est√° fuera de nuestro horario de servicio. Por favor, revisa el horario.</p>
                    </div>
                </div>
            </section>
            <section class="p-3"><h2 class="text-lg font-bold text-red-600 mb-2">üì¶ Tipo de Entrega</h2><div id="delivery-options" class="space-y-2"><button data-value="A Domicilio" class="delivery-option w-full text-left p-3 border-2 border-gray-300 rounded-lg flex items-center space-x-3 transition-all"><span class="text-xl">üè†</span><span class="font-semibold text-sm">A Domicilio</span></button><div id="address-input-container" class="pl-4 hidden"><input type="text" id="address-input" placeholder="Direcci√≥n completa (barrio, apto, etc.)" class="w-full p-2 border-2 border-gray-300 rounded-lg text-sm focus:border-yellow-400 focus:ring-yellow-400"><p class="text-xs text-gray-500 mt-1">Puedes incluir enlaces de Google Maps o Waze.</p></div><button data-value="Para Recoger en Caja" class="delivery-option w-full text-left p-3 border-2 border-gray-300 rounded-lg flex items-center space-x-3 transition-all"><span class="text-xl">ü•°</span><span class="font-semibold text-sm">Para Recoger en Caja</span></button><button data-value="Comer en el Establecimiento" class="delivery-option w-full text-left p-3 border-2 border-gray-300 rounded-lg flex items-center space-x-3 transition-all"><span class="text-xl">üçΩÔ∏è</span><span class="font-semibold text-sm">Comer en el Establecimiento</span></button></div></section>
            <section class="p-3"><h2 class="text-lg font-bold text-red-600 mb-2">üí≥ M√©todo de Pago</h2><div id="payment-methods-container" class="grid grid-cols-2 gap-2"></div><div id="payment-proof-notice" class="mt-3 p-2 bg-yellow-100 border border-yellow-400 text-yellow-800 rounded-lg text-xs hidden"><p>üìé Recuerda enviar tu comprobante de pago v√≠a WhatsApp para validar tu pedido.</p><p class="mt-1 font-bold">‚ö†Ô∏è Para pedidos programados el pago en l√≠nea es obligatorio.</p></div></section>
            <section class="p-3"><button id="send-order-btn" class="w-full bg-green-500 text-white font-bold text-base py-3 px-4 rounded-xl shadow-lg transform hover:scale-105 transition-transform duration-200 flex items-center justify-center space-x-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg><span>Enviar Pedido por WhatsApp</span></button></section>
        </div>

        <div id="confirmation-view" class="view hidden-view p-6 text-center flex flex-col items-center justify-center min-h-screen"><div class="bg-green-100 rounded-full p-3 mb-4"><svg class="w-14 h-14 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></div><h1 class="text-2xl font-black text-green-600 mb-1">¬°Pedido Enviado!</h1><p class="text-gray-600 text-sm mb-5">Tu pedido ha sido recibido y est√° siendo preparado.</p><div class="bg-yellow-400 border-2 border-black text-black font-bold p-3 rounded-lg shadow-lg mb-5 w-full max-w-xs"><p class="text-xs">N√öMERO DE PEDIDO</p><p id="order-number-display" class="text-3xl tracking-widest"></p></div><p class="text-gray-500 text-sm mb-6">Guarda este n√∫mero para consultas.</p><button id="new-order-btn" class="w-full max-w-xs bg-red-600 text-white font-bold py-2.5 px-5 rounded-lg shadow-md transform hover:scale-105 transition-transform duration-200">Hacer otro pedido</button></div>
        
        <div id="location-view" class="view hidden-view">
            <header class="p-3 border-b-2 border-black"><h1 class="text-xl font-black text-red-600 text-center">üìç Nuestras Sedes</h1></header>
            <div class="p-4">
                <div class="bg-white border-2 border-black rounded-lg p-4 shadow-md">
                    <h2 class="font-bold text-lg">Sede Principal - Brisas de los √Ålamos</h2>
                    <p id="address-text" class="text-gray-700 mt-1 mb-4"></p>
                    <div class="grid grid-cols-2 gap-3">
                        <a id="open-maps-btn" href="#" target="_system" class="text-center w-full bg-blue-500 text-white font-bold text-sm py-2.5 px-3 rounded-lg shadow-md hover:bg-blue-600 transition-colors">Abrir en Google Maps</a>
                        <button id="copy-address-btn" class="w-full bg-gray-200 text-black font-bold text-sm py-2.5 px-3 rounded-lg shadow-md hover:bg-gray-300 transition-colors">Copiar Direcci√≥n</button>
                    </div>
                </div>
            </div>
            <div class="px-4 h-96">
                <iframe 
                    id="gmaps-iframe"
                    class="w-full h-full border-2 border-black rounded-lg"
                    loading="lazy"
                    allowfullscreen
                    referrerpolicy="no-referrer-when-downgrade"
                    src="">
                </iframe>
            </div>
        </div>

    </div>

    <footer id="nav-footer" class="fixed bottom-0 left-0 right-0 max-w-lg mx-auto bg-black text-white p-1.5 flex justify-around items-center border-t-2 border-yellow-400"><button id="nav-menu-btn" class="flex-1 text-center py-2 px-3 bg-red-600 rounded-md font-bold mx-1 transition-transform transform hover:scale-105 text-sm">üè† Men√∫</button><button id="nav-cart-btn" class="flex-1 text-center py-2 px-3 bg-yellow-400 text-black rounded-md font-bold mx-1 transition-transform transform hover:scale-105 text-sm">üõí Pedido <span id="cart-count" class="bg-red-600 text-white text-xs font-bold rounded-full px-1.5 py-0.5 ml-1 hidden">0</span></button></footer>

    <canvas id="ticketCanvas" class="hidden"></canvas>


<script>

const checkWritePermission = () => {
        return new Promise((resolve, reject) => {
             if (window.cordova && window.cordova.plugins && cordova.plugins.permissions) {
                  const permissions = cordova.plugins.permissions;
                  // El permiso de ESCRITURA incluye LECTURA
                  const permission = permissions.WRITE_EXTERNAL_STORAGE; 

                 permissions.hasPermission(permission, (status) => {
                     if (status.hasPermission) {
                        resolve(true); // Permiso concedido
                    } else {
                        // Si no tiene, solicitamos
                        permissions.requestPermission(permission, (status) => {
                             if (status.hasPermission) {
                                resolve(true); // Concedido despu√©s de la solicitud
                            } else {
                                 // Aqu√≠ solo alertamos, pero resolvemos en false para que el flujo sepa.
                                 alert("Permiso de almacenamiento denegado. No podremos guardar ni compartir el ticket.");
                                 resolve(false); // Denegado
                             }
                        }, (e) => {
                             // Error al solicitar (ej. usuario hace click fuera)
                             console.error("Error al solicitar permiso:", e);
                             reject(e); 
                        });
                    }
                });
            } else {
                console.warn("Plugins de permisos no disponibles. Asumiendo permiso.");
                resolve(true);
            }
          });
    };
// index.html (Donde tienes definida la funci√≥n onDeviceReady)

function onDeviceReady() {
    // Escuchar la URL de la aplicaci√≥n
    handleOpenURL(); 

    // ‚úÖ ¬°ESTA ES LA CLAVE! 
    // Aseguramos que se solicite el permiso tan pronto como Cordova est√© listo.
    checkWritePermission()
        .then(granted => {
             // Puedes guardar el estado del permiso si es necesario
             console.log("Permiso de almacenamiento al inicio:", granted ? "CONCEDIDO" : "DENEGADO");
             // Continuar con la inicializaci√≥n de la app
             startApp();
        })
        .catch(error => {
            console.error("Fallo cr√≠tico al gestionar permisos. La app puede fallar.", error);
            startApp(); // Intentar iniciar de todas formas
        });
}
function handleExternalLinks() {
    // 1. Verificar si estamos en Cordova Y si el plugin InAppBrowser est√° cargado.
    if (!window.cordova || !window.cordova.InAppBrowser) {
        return; // No hacemos nada si no estamos en Cordova o falta el plugin.
    }

    // 2. Escuchar todos los clics en la ventana.
    document.addEventListener('click', function(e) {
        // Encontrar el elemento <a> m√°s cercano al clic (puede ser un hijo)
        let target = e.target.closest('a');

        // Si no es un enlace <a> o no tiene atributo href, ignorar.
        if (!target || !target.href) return;

        // Opcional: Si el enlace est√° vac√≠o o es un ancla interna (#), ignorar.
        if (target.href === '#' || target.href.startsWith('javascript:')) return;

        // Opcional: Si es un enlace a tu propia webapp, ignorar (solo si cargaras el HTML localmente)
        // Ya que est√°s cargando un HTML remoto, asumiremos que todos los http/https externos son externos.

        // Si es un enlace:
        // Evitar la acci√≥n por defecto (que es intentar cargar la URL en el WebView)
        e.preventDefault();

        // Forzar la apertura en la aplicaci√≥n del sistema (navegador, WhatsApp, Maps, etc.)
        cordova.InAppBrowser.open(target.href, '_system');
    });
}
    
// ‚úÖ REQ 1: Main app logic is wrapped to be called by the correct event listener.
function startApp() {

    const shareTicketOnWhatsApp = (message, filePath) => {
        if (window.plugins && window.plugins.socialsharing) {
            window.plugins.socialsharing.shareViaWhatsApp(
                message,
                filePath,         // URI del archivo guardado (ej: file:///...)
                null,
                () => { 
                    console.log('Compartido exitosamente');
                    alert("‚úÖ Pedido enviado por WhatsApp.");
                },
                (errormsg) => { 
                    console.error('Error al compartir: ' + errormsg);
                    alert("‚ùå Error al compartir el pedido. Intenta de nuevo.");
                }
            );
        } else {
            alert("Plugin de Social Sharing no disponible. Abriendo WhatsApp solo con el mensaje de texto.");
            // Fallback (solo texto)
            if (window.cordova && cordova.InAppBrowser) {
                const whatsappUrl = `whatsapp://send?phone=${WHATSAPP_NUMBER}&text=${message}`;
                cordova.InAppBrowser.open(whatsappUrl, '_system');
            }
        }
    };
    const RESTAURANT_NAME = "K‚ÄôLe√±os Sabor 100% Valluno";
    const WHATSAPP_NUMBER = "573216350541";
    
    const LOCATION_DATA = {
        address: "Cl. 75a Nte. #2-110, Acopi, Cali, Valle del Cauca, Colombia",
        map_url: "geo:3.4940402337368077,-76.50136182453736?q=K\'Le√±os - Sabor 100% Valluno" // Corrected embed URL base
    };

    const SOCIAL_LINKS = {
        instagram: "https://www.instagram.com/franquiciasvallunas/",
        facebook: "https://www.facebook.com/FranquiciasVallunas/",
        whatsapp: `https://wa.me/573216350541`,
        tiktok: "https://www.tiktok.com/user/profile/7238343093483815941",
        website: "https://www.kle√±os.com/"
    };

    const MENU_ITEMS = [
        { id: 1, name: "üî• 2x1 Combinado (Hamburguesa o Perro)", category: "Promos", price: 18.90 },{ id: 2, name: "üçî Hamburguesa Especial", category: "Hamburguesas", price: 10.50 },{ id: 3, name: "üçî Hamburguesa Especial (Tocineta y Queso)", category: "Hamburguesas", price: 13.50 },{ id: 4, name: "üçî Hamb. con Filete de Pollo Apanado", category: "Hamburguesas", price: 15.90 },{ id: 5, name: "üçî Hamburguesa Mixta", category: "Hamburguesas", price: 19.50 },{ id: 6, name: "ü´ì Arepa Burger", category: "Hamburguesas", price: 14.90 },{ id: 7, name: "üå≠ Perro Americano", category: "Perros Calientes", price: 10.50 },{ id: 8, name: "üå≠ Perro Especial Americano", category: "Perros Calientes", price: 13.50 },{ id: 9, name: "üå≠ Perro Americano + Filete de Pollo", category: "Perros Calientes", price: 17.90 },{ id: 10, name: "ü•© Churrasco", category: "Asados", price: 29.50 },{ id: 11, name: "ü•© Carne Asada", category: "Asados", price: 26.90 },{ id: 12, name: "üçó Filete de Pollo a la Parrilla", category: "Asados", price: 25.90 },{ id: 13, name: "üçó Filete de Pollo Gratinado", category: "Asados", price: 27.90 },{ id: 14, name: "üçñ Costillas a la BBQ", category: "Asados", price: 23.50 },{ id: 15, name: "üç¢ Chuzos (Cerdo, Pollo o Costilla) + Papa", category: "Asados", price: 14.90 },{ id: 16, name: "üê∑ Chuleta Valluna (Cerdo o Pollo)", category: "Fritos", price: 25.90 },{ id: 17, name: "üçü Salchipapa Especial", category: "Fritos", price: 10.50 },{ id: 18, name: "üçü Salchipapa con Costilla Ahumada", category: "Fritos", price: 15.90 },{ id: 19, name: "üçü Salchipapa (Costilla + Pollo)", category: "Fritos", price: 25.90 },{ id: 20, name: "üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Salchipapa Especial Familiar", category: "Fritos", price: 45.50 },{ id: 21, name: "üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Salchipapa Familiar con Todo", category: "Fritos", price: 67.90 },{ id: 22, name: "üî• Parrillada o Picada de 4 Carnes", category: "Parrillada", price: 65.90 },{ id: 23, name: "‚ûï Papa a la Francesa", category: "Adiciones", price: 5.00 },{ id: 24, name: "‚ûï Papa Criolla", category: "Adiciones", price: 5.00 },{ id: 25, name: "‚ûï Tocineta o Queso", category: "Adiciones", price: 3.00 },{ id: 26, name: "‚ûï Adici√≥n Carne de Hamburguesa", category: "Adiciones", price: 5.00 },{ id: 27, name: "‚ûï Adici√≥n Filete de Pollo Parrilla", category: "Adiciones", price: 6.90 },{ id: 28, name: "‚ûï Adici√≥n Filete de Pollo Apanado", category: "Adiciones", price: 7.50 }
    ];

    const PAYMENT_METHODS = [ { name: "Efectivo", icon: "üíµ" }, { name: "Nequi", icon: "üí≥" }, { name: "Bancolombia", icon: "üí≥" }];

    const OPERATING_HOURS = [
        { day: 0, start: '17:00', end: '23:00', closeMsg: "Hoy a las 11:00 PM" }, { day: 1, start: null, end: null, closeMsg: "Ma√±ana a las 5:00 PM" }, { day: 2, start: '17:00', end: '23:00', closeMsg: "Hoy a las 11:00 PM" }, { day: 3, start: '17:00', end: '23:00', closeMsg: "Hoy a las 11:00 PM" }, { day: 4, start: '17:00', end: '23:00', closeMsg: "Hoy a las 11:00 PM" }, { day: 5, start: '17:00', end: '24:00', closeMsg: "Hoy a las 12:00 AM" }, { day: 6, start: '17:00', end: '24:00', closeMsg: "Hoy a las 12:00 AM" }
    ];

    let cart = [];
    let customerName = "";
    let customerPhone = "";
    let selectedDelivery = null;
    let deliveryAddress = "";
    let selectedPayment = null;
    let currentOrderNumber = null;
    let currentFilter = "all";
    let isScheduled = false;

    const menuView = document.getElementById('menu-view');
    const cartView = document.getElementById('cart-view');
    const confirmationView = document.getElementById('confirmation-view');
    const locationView = document.getElementById('location-view');
    const productList = document.getElementById('product-list');
    const cartItemsContainer = document.getElementById('cart-items-container');
    const cartTotalEl = document.getElementById('cart-total');
    const cartCountEl = document.getElementById('cart-count');
    const emptyCartMessage = document.getElementById('empty-cart-message');
    const customerNameInput = document.getElementById('customer-name-input');
    const customerPhoneInput = document.getElementById('customer-phone-input');
    const deliveryOptions = document.getElementById('delivery-options');
    const addressInputContainer = document.getElementById('address-input-container');
    const addressInput = document.getElementById('address-input');
    const paymentMethodsContainer = document.getElementById('payment-methods-container');
    const paymentProofNotice = document.getElementById('payment-proof-notice');
    const sendOrderBtn = document.getElementById('send-order-btn');
    const newOrderBtn = document.getElementById('new-order-btn');
    const locationBtn = document.getElementById('location-btn');
    const openMapsBtn = document.getElementById('open-maps-btn');
    const copyAddressBtn = document.getElementById('copy-address-btn');
    const navMenuBtn = document.getElementById('nav-menu-btn');
    const navCartBtn = document.getElementById('nav-cart-btn');
    const navFooter = document.getElementById('nav-footer');
    const filtersSection = document.getElementById('filters-section');
    const categoryBtns = document.querySelectorAll('.category-btn');
    const operatingStatusBox = document.getElementById('operating-status-box');
    const statusIcon = document.getElementById('status-icon');
    const statusMessageMain = document.getElementById('status-message-main');
    const statusMessageSecondary = document.getElementById('status-message-secondary');
    const deliveryTimeNowOption = document.getElementById('delivery-time-now-option');
    const deliveryTimeScheduleOption = document.getElementById('delivery-time-schedule-option');
    const scheduleInputContainer = document.getElementById('schedule-input-container');
    const scheduledDateInput = document.getElementById('scheduled-date-input');
    const scheduledTimeInput = document.getElementById('scheduled-time-input');
    const scheduleWarning = document.getElementById('schedule-warning');
    
    // ‚úÖ REQ 3.A: Helper function to convert Data URL to Blob
    const b64toBlob = (dataURL, mimeType) => {
        const base64 = dataURL.split(',')[1];
        const binary = atob(base64);
        const array = [];
        for (let i = 0; i < binary.length; i++) {
            array.push(binary.charCodeAt(i));
        }
        return new Blob([new Uint8Array(array)], { type: mimeType });
    };

    // ‚úÖ REQ 3.B: Main function to save the ticket image using cordova-plugin-file
    const saveTicketImage = (dataURL, fileName) => {
        return new Promise((resolve, reject) => { 
        
            if (!(window.cordova && window.resolveLocalFileSystemURL && typeof b64toBlob === 'function')) {
                console.error("Plugins de Cordova o b64toBlob no est√°n listos.");
                return reject("Plugins no listos o b64toBlob no definido."); 
            }

            const blob = b64toBlob(dataURL, 'image/png'); 
            const storagePath = cordova.file.externalRootDirectory + 'Download/'; 

            window.resolveLocalFileSystemURL(storagePath, (dirEntry) => {
                dirEntry.getFile(fileName, { create: true, exclusive: false }, (fileEntry) => {
                    fileEntry.createWriter((fileWriter) => {
                        fileWriter.onwriteend = () => {
                            // CORRECCI√ìN AQU√ç üëá: Usa la propiedad, no una funci√≥n
                            console.log(`Ticket guardado: ${fileEntry.nativeURL}`); 
                            // ASEG√öRATE de que esta l√≠nea exista para resolver la Promise
                            resolve(fileEntry.nativeURL); 
                        };
                        fileWriter.onerror = (e) => {
                            console.error(`Error de escritura: ${e.toString()}`);
                            reject(e); // Rechazar si hay error
                        };
                        fileWriter.write(blob);
                    }, reject); // Rechazar si falla createWriter
                }, reject); // Rechazar si falla getFile
            }, reject); // Rechazar si falla resolveLocalFileSystemURL
        });
    };
    const formatMenuPrice = (price) => `$${price.toFixed(1)}K`;
    const formatRealAmount = (realAmount) => `$${realAmount.toLocaleString('es-CO', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;

    const getOperatingStatus = (checkTime) => {
        const now = checkTime || new Date(); const day = now.getDay(); const hours = now.getHours(); const minutes = now.getMinutes(); const schedule = OPERATING_HOURS[day]; if (!schedule.start) { let nextDayIndex = 2; if(day === 6) nextDayIndex = 0; const nextOpenDay = new Date(now); nextOpenDay.setDate(now.getDate() + (nextDayIndex - day + 7) % 7); const nextDayName = nextOpenDay.toLocaleDateString('es-ES', { weekday: 'long' }); return { isOpen: false, status: "En este momento estamos tomando un breve descanso. üò¥", nextOpen: `${nextDayName} a las 5:00 PM` }; } const [startHour, startMinute] = schedule.start.split(':').map(Number); const [endHour, endMinute] = schedule.end.split(':').map(Number); const currentTimeInMinutes = hours * 60 + minutes; const startTimeInMinutes = startHour * 60 + startMinute; const endTimeInMinutes = (endHour === 24 ? 24 * 60 : endHour * 60) + endMinute; if (currentTimeInMinutes >= startTimeInMinutes && currentTimeInMinutes < endTimeInMinutes) { return { isOpen: true, status: "ABIERTO", nextClose: `Cierre: ${schedule.closeMsg}` }; } else if (currentTimeInMinutes < startTimeInMinutes) { return { isOpen: false, status: "En este momento estamos tomando un breve descanso. üò¥", nextOpen: `Hoy a las ${schedule.start.replace(':00', '').replace('17:00', '5:00 PM')}` }; } else { const nextDayIndex = (day + 1) % 7; const nextOpenDay = new Date(now); nextOpenDay.setDate(now.getDate() + 1); let nextOpen = OPERATING_HOURS[nextDayIndex].start ? nextOpenDay.toLocaleDateString('es-ES', { weekday: 'long' }) + ' a las 5:00 PM' : 'Martes a las 5:00 PM'; return { isOpen: false, status: "En este momento estamos tomando un breve descanso. üò¥", nextOpen: nextOpen }; }
    };
    const updateOperatingStatusDisplay = () => {
        const status = getOperatingStatus(); operatingStatusBox.className = 'p-3 border-2 rounded-xl text-center shadow-lg mx-3 mt-3'; if (status.isOpen) { operatingStatusBox.classList.add('bg-green-100', 'border-2', 'border-green-500'); statusIcon.textContent = '‚úÖ'; statusMessageMain.textContent = `¬°Estamos ${status.status} ahora! Haz tu pedido.`; statusMessageSecondary.textContent = status.nextClose; } else { operatingStatusBox.classList.add('bg-yellow-100', 'border-2', 'border-yellow-600'); statusIcon.textContent = 'üå§Ô∏èüå•Ô∏è‚òÅÔ∏èüåßÔ∏è‚òÅÔ∏èüå•Ô∏èüå§Ô∏è'; statusMessageMain.textContent = `¬°Hola! ${status.status}`; statusMessageSecondary.textContent = `Abrimos ${status.nextOpen}. ¬°A√∫n puedes programar tu pedido para que sea de los primeros! üòâ.`; }
    };
    const isScheduledTimeValid = (date, time) => {
        if (!date || !time) return false; const scheduledDateTime = new Date(`${date}T${time}:00`); const scheduledDay = scheduledDateTime.getDay(); const scheduledHours = scheduledDateTime.getHours(); const scheduledMinutes = scheduledDateTime.getMinutes(); const schedule = OPERATING_HOURS[scheduledDay]; if (!schedule.start) return false; const [startHour, startMinute] = schedule.start.split(':').map(Number); const [endHour, endMinute] = schedule.end.split(':').map(Number); const scheduledTimeInMinutes = scheduledHours * 60 + scheduledMinutes; const startTimeInMinutes = startHour * 60 + startMinute; const endTimeInMinutes = (endHour === 24 ? 24 * 60 : endHour * 60) + endMinute; return scheduledTimeInMinutes >= startTimeInMinutes && scheduledTimeInMinutes < endTimeInMinutes;
    };
    const checkScheduleInputs = () => {
        const date = scheduledDateInput.value; const time = scheduledTimeInput.value; if (isScheduled && date && time) { const isValid = isScheduledTimeValid(date, time); if (!isValid) { scheduleWarning.classList.remove('hidden'); } else { scheduleWarning.classList.add('hidden'); } return isValid; } scheduleWarning.classList.add('hidden'); return true; 
    };
    const renderMenu = () => {
        productList.innerHTML = ''; const f = currentFilter === 'all' ? MENU_ITEMS : MENU_ITEMS.filter(i => i.category === currentFilter); if(f.length === 0){ productList.innerHTML = `<p class="text-center text-gray-500 col-span-1">No hay productos en esta categor√≠a.</p>`; return; } f.forEach(i => { const c = document.createElement('div'); c.className = "bg-white border-2 border-black rounded-lg p-3 flex justify-between items-center shadow-md"; c.innerHTML = `<div class="flex-1 pr-2"><h3 class="text-base font-bold">${i.name}</h3><p class="text-gray-800 font-semibold text-sm">${formatMenuPrice(i.price)}</p></div><button data-id="${i.id}" class="add-to-cart-btn bg-red-600 text-white font-bold py-2 px-4 rounded-full shadow-lg transform hover:scale-110 transition-transform text-sm">+ Agregar</button>`; productList.appendChild(c); });
    };
    const renderCart = () => {
        cartItemsContainer.innerHTML = ''; if (cart.length === 0) { emptyCartMessage.classList.remove('hidden'); cartItemsContainer.classList.add('hidden'); } else { emptyCartMessage.classList.add('hidden'); cartItemsContainer.classList.remove('hidden'); cart.forEach(i => { const realPrice = i.price * 1000; const s = realPrice * i.quantity; const e = document.createElement('div'); e.className = "bg-gray-50 border border-gray-200 rounded-lg p-2.5"; e.innerHTML = `<div class="flex justify-between items-start"><div><p class="font-bold text-sm">${i.name}</p><p class="text-xs text-gray-600">${formatRealAmount(realPrice)} c/u</p></div><p class="font-bold text-base text-red-600">${formatRealAmount(s)}</p></div><div class="flex items-center justify-between mt-2"><div class="flex items-center space-x-2"><button data-id="${i.id}" class="quantity-change-btn bg-gray-200 w-7 h-7 rounded-full font-bold text-base">-</button><span class="font-bold w-7 text-center text-sm">${i.quantity}</span><button data-id="${i.id}" class="quantity-change-btn bg-gray-200 w-7 h-7 rounded-full font-bold text-base">+</button><button data-id="${i.id}" class="remove-item-btn text-gray-500 hover:text-red-600 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></div></div><textarea data-id="${i.id}" class="note-input w-full mt-2 p-2 border border-gray-300 rounded-lg text-xs" placeholder="Indicaciones especiales (ej: sin cebolla)...">${i.note || ''}</textarea>`; cartItemsContainer.appendChild(e); }); } updateCartTotal(); updateCartCount();
    };
    const renderPaymentMethods = () => {
        paymentMethodsContainer.innerHTML = ''; PAYMENT_METHODS.forEach(m => { const b = document.createElement('button'); b.dataset.value = m.name; b.className = 'payment-option w-full text-left p-2.5 border-2 border-gray-300 rounded-lg flex items-center space-x-2 transition-all'; b.innerHTML = `<span class="text-lg">${m.icon}</span><span class="font-semibold text-sm">${m.name}</span>`; paymentMethodsContainer.appendChild(b); });
    };
    const renderSocialLinks = () => {
        const container = document.getElementById('social-links-container');
        container.innerHTML = `
            <!-- Instagram -->
            <a href="#"
               onclick="try{window.location='instagram://user?username=franquiciasvallunas';
               setTimeout(()=>window.open('https://instagram.com/franquiciasvallunas','_system'),700);}
               catch(e){window.open('https://instagram.com/franquiciasvallunas','_system');}"
               class="text-black hover:text-red-600 transition-colors">
               <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                   <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.85s-.011 3.584-.069 4.85c-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07s-3.584-.012-4.85-.07c-3.252-.148-4.771-1.691-4.919-4.919-.058-1.265-.069-1.645-.069-4.85s.011-3.584.069-4.85c.149-3.225 1.664-4.771 4.919-4.919C8.416 2.175 8.796 2.163 12 2.163m0-2.163C8.741 0 8.333.014 7.053.072 2.695.272.273 2.69.073 7.052.014 8.333 0 8.741 0 12s.014 3.667.072 4.947c.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072s3.667-.014 4.947-.072c4.358-.2 6.78-2.618 6.98-6.98.059-1.281.073-1.689.073-4.948s-.014-3.667-.072-4.947c-.2-4.358-2.618-6.78-6.98-6.98C15.667.014 15.259 0 12 0zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.162 6.162 6.162 6.162-2.759 6.162-6.162-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4s1.791-4 4-4 4 1.79 4 4-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44 1.441-.645 1.441-1.44-.645-1.44-1.441-1.44z"/>
               </svg>
            </a>

            <!-- Facebook -->
            <a href="#"
               onclick="try{window.location='fb://facewebmodal/f?href=https://www.facebook.com/FranquiciasVallunas/';
               setTimeout(()=>window.open('https://www.facebook.com/FranquiciasVallunas/','_system'),700);}
               catch(e){window.open('https://www.facebook.com/FranquiciasVallunas/','_system');}"
               class="text-black hover:text-red-600 transition-colors">
               <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                   <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
               </svg>
            </a>

            <!-- WhatsApp -->
            <a href="#"
               onclick="try{window.location='whatsapp://send?phone=573216350541';
               setTimeout(()=>window.open('https://wa.me/573216350541','_system'),700);}
               catch(e){window.open('https://wa.me/573216350541','_system');}"
               class="text-black hover:text-red-600 transition-colors">
               <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                   <path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.894 11.892-1.99 0-3.903-.52-5.687-1.448L.057 24zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.886-.001 2.267.655 4.398 1.803 6.182l-.341 1.236 1.254-.328zM9.062 7.032c-.092-.158-.297-.184-.452-.184-.132 0-.279.006-.411.006-.151 0-.393.072-.601.297-.229.252-.866 1.011-.866 2.474s.885 2.868 1.004 3.064c.124.19 1.764 2.951 4.298 4.251 2.108 1.086 2.857.944 3.482.903.729-.048 1.503-.615 1.711-1.206.212-.604.212-1.115.152-1.233-.06-.124-.216-.19-.435-.318s-1.29-.714-1.494-.812c-.204-.099-.351-.158-.498.158-.146.315-.563.714-.689.869-.126.152-.252.179-.47.065-.218-.113-1.002-.41-1.892-1.285-.712-.689-1.227-1.688-1.353-1.969-.124-.282-.016-.443.138-.59.138-.132.302-.351.452-.524.146-.17.195-.297.294-.494.099-.19.049-.375-.015-.524-.065-.147-.594-1.599-.812-2.181z"/>
               </svg>
            </a>

            <!-- TikTok -->
            <a href="#"
               onclick="try{window.location='tiktok://user/profile/7238343093483815941';
               setTimeout(()=>window.open('https://www.tiktok.com/@franquiciasvallunas','_system'),700);}
               catch(e){window.open('https://www.tiktok.com/@franquiciasvallunas','_system');}"
               class="text-black hover:text-red-600 transition-colors">
               <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 448 512">
                   <path d="M448 209.91a210.06 210.06 0 0 1-122.77-39.25V349.38A162.55 162.55 0 1 1 185 188.31V278.2a74.62 74.62 0 1 0 52.23 71.18V0l88 0a121.18 121.18 0 0 0 1.86 22.17h0A122.18 122.18 0 0 0 381 102.39a121.43 121.43 0 0 0 67 20.14Z"/>
               </svg>
            </a>

            <!-- Website -->
            <a href="#"
               onclick="try{window.location='intent://www.kle√±os.com/';
               setTimeout(()=>window.open('https://www.kle√±os.com/','_system'),700);}
               catch(e){window.open('https://www.kle√±os.com/','_system');}"
               class="text-black hover:text-red-600 transition-colors">
               <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                   <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v-.07zM13 15v-1c0-1.1-.9-2-2-2h-1V9h1c1.1 0 2-.9 2-2V6.1c1.79.45 3.29 1.73 4.16 3.42-.32.06-.63.15-.92.28-.9.39-1.92.6-3.24.6h-1v3h1c1.32 0 2.34.21 3.24.6.29.13.59.22.92.28C16.29 13.27 14.79 14.55 13 14.99V15zm6.79-1.79c.13.58.21 1.17.21 1.79 0 4.08-3.05 7.44-7 7.93V17c1.1 0 2-.9 2-2v-1l4.79-4.79z"/>
               </svg>
            </a>
        `;
    };

    const updateCartTotal = () => { const t = cart.reduce((s, i) => s + (i.price * 1000) * i.quantity, 0); cartTotalEl.textContent = formatRealAmount(t); };
    const updateCartCount = () => { const c = cart.reduce((s, i) => s + i.quantity, 0); if (c > 0) { cartCountEl.textContent = c; cartCountEl.classList.remove('hidden'); } else { cartCountEl.classList.add('hidden'); } };
    const addToCart = (pId) => { const p = MENU_ITEMS.find(p => p.id === pId); const c = cart.find(i => i.id === pId); if (c) { c.quantity++; } else { cart.push({ ...p, quantity: 1, note: '' }); } renderCart(); };
    const handleQuantityChange = (pId, op) => { const i = cart.find(item => item.id === pId); if (i) { if (op === '+') { i.quantity++; } else if (op === '-' && i.quantity > 1) { i.quantity--; } else { removeFromCart(pId); } } renderCart(); };
    const removeFromCart = (pId) => { cart = cart.filter(i => i.id !== pId); renderCart(); };
    const updateNote = (pId, n) => { const i = cart.find(item => item.id === pId); if (i) { i.note = n; } };
    const switchView = (vName) => { [menuView, cartView, confirmationView, locationView].forEach(v => { v.id === vName ? v.classList.remove('hidden-view') : v.classList.add('hidden-view'); }); navFooter.style.display = vName === 'confirmation-view' ? 'none' : 'flex'; filtersSection.style.display = vName === 'menu-view' ? 'block' : 'none'; window.scrollTo(0, 0); };
    const generateOrderNumber = () => Math.floor(100000 + Math.random() * 900000);

    const validateOrder = () => { if(cart.length===0){alert('Tu carrito est√° vac√≠o. Agrega productos para continuar.');return false;} if (customerName.trim() === '') { alert('Por favor, ingresa tu nombre.'); customerNameInput.focus(); return false; } if (customerPhone.trim() === '' || customerPhone.trim().length < 7) { alert('Por favor, ingresa un n√∫mero de WhatsApp v√°lido.'); customerPhoneInput.focus(); return false; } if (!isScheduled) { const status = getOperatingStatus(); if (!status.isOpen) { alert(`Estamos cerrados ahora. Para poder hacer tu pedido, por favor, selecciona la opci√≥n "Programar para despu√©s" y elige una hora v√°lida.`); return false; } } else { if (!scheduledDateInput.value || !scheduledTimeInput.value) { alert('Por favor, selecciona una fecha y hora para programar tu pedido.'); return false; } if (!checkScheduleInputs()) { alert('La hora que seleccionaste est√° fuera de nuestro horario de servicio. Por favor, selecciona una hora v√°lida (Domingos a Jueves: 5 PM - 11 PM / Viernes y S√°bados: 5 PM - 12 AM).'); return false; } const scheduledDateTime = new Date(`${scheduledDateInput.value}T${scheduledTimeInput.value}:00`); if (scheduledDateTime < new Date()) { alert('La hora programada no puede ser en el pasado.'); return false; } if (selectedPayment === 'Efectivo') { alert('Para pedidos programados (reservas), el pago debe ser en l√≠nea (Nequi/Bancolombia) para confirmar tu pedido.'); return false; } } if(!selectedDelivery){alert('Por favor, selecciona un tipo de entrega.');return false;} if(selectedDelivery==='A Domicilio'&&deliveryAddress.trim()===''){alert('Por favor, ingresa tu direcci√≥n de domicilio.');addressInput.focus();return false;} if(!selectedPayment){alert('Por favor, selecciona un m√©todo de pago.');return false;} return true; };
    const formatWhatsAppMessage = () => { let m = `üõçÔ∏è *NUEVO PEDIDO #${currentOrderNumber}*\n\n`; if (isScheduled) { const date = new Date(`${scheduledDateInput.value}T${scheduledTimeInput.value}:00`); const dateStr = date.toLocaleDateString('es-CO', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); m += `‚è∞ *PEDIDO PROGRAMADO (RESERVA)*\n`; m += `D√≠a: ${dateStr}\n`; m += `Hora: ${scheduledTimeInput.value}\n\n`; } else { m += `‚è∞ *ENTREGA INMEDIATA:*\n`; m += `Tan pronto como sea posible. (Hora de env√≠o: ${new Date().toLocaleTimeString('es-CO')})\n\n`; } m += `üë§ *CLIENTE:*\n`; m += `Nombre: ${customerName.trim()}\n`; m += `Tel√©fono: ${customerPhone.trim()}\n\n`; m += `üìã *DETALLE DEL PEDIDO:*\n`; cart.forEach((i, idx) => { const realPrice = i.price * 1000; const subtotal = i.quantity * realPrice; m += `${idx+1}. *${i.name}*\n   Cantidad: ${i.quantity}\n   Precio: ${formatRealAmount(realPrice)} c/u\n   Subtotal: ${formatRealAmount(subtotal)}\n`; if(i.note.trim()!==''){m+=`   üìù Nota: ${i.note.trim()}\n`;} m+='\n'; }); const total = cart.reduce((s,i)=>(s+(i.price*1000)*i.quantity),0); m+=`üí∞ *TOTAL: ${formatRealAmount(total)}*\n\n`; let e=''; if(selectedDelivery==='A Domicilio')e='üè†'; if(selectedDelivery==='Para Recoger en Caja')e='ü•°'; if(selectedDelivery==='Comer en el Establecimiento')e='üçΩÔ∏è'; m+=`üì¶ *TIPO DE ENTREGA:* ${e} ${selectedDelivery}\n`; if(selectedDelivery==='A Domicilio'&&deliveryAddress){m+=`üìç Direcci√≥n: ${deliveryAddress}\n`;} m+=`\nüí≥ *M√âTODO de PAGO:* ${selectedPayment}\n`; if(isScheduled || selectedPayment!=='Efectivo'){m+=`üìé Comprobante enviado v√≠a WhatsApp\n`;} m+=`\n`; return encodeURIComponent(m); };
    const resetApp = () => { cart=[]; customerName = ""; customerPhone = ""; selectedDelivery=null; deliveryAddress=""; selectedPayment=null; currentOrderNumber=null; isScheduled = false; customerNameInput.value = ""; customerPhoneInput.value = ""; addressInput.value=""; deliveryTimeNowOption.classList.add('border-yellow-400', 'border-4'); deliveryTimeNowOption.classList.remove('border-gray-300', 'border-2'); deliveryTimeScheduleOption.classList.remove('border-yellow-400', 'border-4'); deliveryTimeScheduleOption.classList.add('border-gray-300', 'border-2'); scheduleInputContainer.classList.add('hidden'); scheduleWarning.classList.add('hidden'); scheduledDateInput.value = ''; scheduledTimeInput.value = ''; addressInputContainer.classList.add('hidden'); document.querySelectorAll('.delivery-option.border-yellow-400').forEach(e=>{e.classList.remove('border-yellow-400','border-4'); e.classList.add('border-gray-300','border-2');}); document.querySelectorAll('.payment-option.border-yellow-400').forEach(e=>{e.classList.remove('border-yellow-400','border-4'); e.classList.add('border-gray-300','border-2');}); paymentProofNotice.classList.add('hidden'); renderCart(); switchView('menu-view'); };
    const wrapText = (c, t, x, y, maxW, lH) => { if (!t || t.trim() === '') return y; const w = t.split(' '); let l = ''; for (let n = 0; n < w.length; n++) { const tL = l + w[n] + ' '; const tW = c.measureText(tL).width; if (tW > maxW && n > 0) { c.fillText(l.trim(), x, y); l = w[n] + ' '; y += lH; } else { l = tL; } } c.fillText(l.trim(), x, y); return y + lH; };
    
    // ‚úÖ REQ 3.C: Function now only draws on canvas and returns the Data URL
    const drawTicketOnCanvas = () => {
        const canvas = document.getElementById('ticketCanvas'); const ctx = canvas.getContext('2d'); const canvasWidth = 800; const padding = 50; let currentY = 0; let estimatedHeight = 400; cart.forEach(item => { estimatedHeight += 45; if (item.note && item.note.trim().length > 0) { const noteLines = Math.ceil(item.note.length / 50); estimatedHeight += noteLines * 30; } }); estimatedHeight += 180; if (deliveryAddress) estimatedHeight += 40; estimatedHeight += 120; canvas.width = canvasWidth; canvas.height = estimatedHeight; ctx.fillStyle = '#FFFFFF'; ctx.fillRect(0, 0, canvasWidth, canvas.height); currentY = padding + 20; ctx.textAlign = 'center'; ctx.fillStyle = '#DC2626'; ctx.font = 'bold 50px Poppins'; currentY = wrapText(ctx, RESTAURANT_NAME, canvasWidth / 2, currentY, canvasWidth - padding, 55); ctx.fillStyle = '#000000'; ctx.font = '32px Poppins'; currentY = wrapText(ctx, `Pedido #${currentOrderNumber}`, canvasWidth / 2, currentY, canvasWidth - padding, 40); ctx.fillStyle = '#555555'; ctx.font = '22px Poppins'; const date = new Date().toLocaleString('es-CO', { dateStyle: 'long', timeStyle: 'short' }); currentY = wrapText(ctx, date, canvasWidth / 2, currentY, canvasWidth - padding, 30); currentY += 15; ctx.textAlign = 'center'; ctx.fillStyle = '#DC2626'; ctx.font = 'bold 28px Poppins'; if (isScheduled) { const schDate = new Date(`${scheduledDateInput.value}T${scheduledTimeInput.value}:00`); const schDateStr = schDate.toLocaleDateString('es-ES', { weekday: 'long', month: 'numeric', day: 'numeric' }); currentY = wrapText(ctx, `Reserva para: ${schDateStr} a las ${scheduledTimeInput.value}`, canvasWidth / 2, currentY, canvasWidth - padding, 35); } else { currentY = wrapText(ctx, `Entrega: Lo m√°s pronto posible`, canvasWidth / 2, currentY, canvasWidth - padding, 35); } currentY += 15; ctx.textAlign = 'left'; ctx.fillStyle = '#000000'; ctx.font = 'bold 26px Poppins'; currentY = wrapText(ctx, `Cliente: ${customerName.trim()}`, padding, currentY, canvasWidth - padding * 2, 35); ctx.font = '26px Poppins'; currentY = wrapText(ctx, `Tel: ${customerPhone.trim()}`, padding, currentY, canvasWidth - padding * 2, 35); currentY += 15; ctx.beginPath(); ctx.moveTo(padding, currentY); ctx.lineTo(canvasWidth - padding, currentY); ctx.strokeStyle = '#000000'; ctx.lineWidth = 2; ctx.stroke(); currentY += 35; ctx.textAlign = 'left'; cart.forEach(item => { const realPrice = item.price * 1000; const subtotal = realPrice * item.quantity; ctx.fillStyle = '#000000'; ctx.font = 'bold 28px Poppins'; const itemY = currentY; currentY = wrapText(ctx, `${item.quantity}x ${item.name}`, padding, currentY, canvasWidth - padding * 2 - 120, 35); ctx.textAlign = 'right'; ctx.fillText(formatRealAmount(subtotal).replace('$', ''), canvasWidth - padding, itemY); ctx.textAlign = 'left'; if (item.note.trim()) { ctx.fillStyle = '#555555'; ctx.font = 'italic 24px Poppins'; currentY = wrapText(ctx, `Nota: ${item.note.trim()}`, padding + 15, currentY, canvasWidth - padding * 2 - 15, 30); } currentY += 10; }); currentY += 15; ctx.beginPath(); ctx.moveTo(padding, currentY); ctx.lineTo(canvasWidth - padding, currentY); ctx.stroke(); currentY += 50; ctx.font = 'bold 42px Poppins'; ctx.fillStyle = '#000000'; ctx.fillText('TOTAL:', padding, currentY); const total = cart.reduce((sum, item) => sum + (item.price * 1000) * item.quantity, 0); ctx.textAlign = 'right'; ctx.fillStyle = '#DC2626'; ctx.fillText(formatRealAmount(total).replace('$', ''), canvasWidth - padding, currentY); ctx.textAlign = 'left'; currentY += 60; ctx.fillStyle = '#000000'; ctx.font = '26px Poppins'; currentY = wrapText(ctx, `Entrega: ${selectedDelivery}`, padding, currentY, canvasWidth - padding * 2, 35); if (selectedDelivery === 'A Domicilio' && deliveryAddress) { currentY = wrapText(ctx, `Direcci√≥n: ${deliveryAddress}`, padding, currentY, canvasWidth - padding * 2, 35); } currentY = wrapText(ctx, `Pago: ${selectedPayment}`, padding, currentY, canvasWidth - padding * 2, 35); ctx.fillStyle = '#FACC15'; ctx.fillRect(0, canvas.height - 60, canvasWidth, 60); ctx.fillStyle = '#000000'; ctx.font = 'bold 26px Poppins'; ctx.textAlign = 'center'; ctx.fillText('¬°Gracias por tu compra!', canvasWidth / 2, canvas.height - 22);
        
        // Return the image data, but don't trigger download here
        return canvas.toDataURL('image/png');
    };

    locationBtn.addEventListener('click', () => switchView('location-view'));
    copyAddressBtn.addEventListener('click', () => { navigator.clipboard.writeText(LOCATION_DATA.address).then(() => { copyAddressBtn.textContent = '¬°Copiado!'; setTimeout(() => { copyAddressBtn.textContent = 'Copiar Direcci√≥n'; }, 2000); }); });
    
    // ‚úÖ REQ 2 & 3: Modified button listener to integrate Cordova plugins
    sendOrderBtn.addEventListener('click', async () => {
        if (!validateOrder()) return; 

        // 2. GENERAR Y GUARDAR TICKET (USANDO await)
        currentOrderNumber = generateOrderNumber(); 
        const ticketDataURL = drawTicketOnCanvas(); 

        try {
            const message = formatWhatsAppMessage();
            const fileName = `Ticket-Pedido-${currentOrderNumber}.png`;
        
            // Espera a que el archivo se guarde y obt√©n su URI (filePath)
            const filePath = await saveTicketImage(ticketDataURL, fileName); 

            // 3. COMPARTIR TICKET CON IMAGEN ADJUNTA (Usando la nueva funci√≥n)
            shareTicketOnWhatsApp(message, filePath); 

            // 4. ACTUALIZAR UI (tu l√≥gica original)
            document.getElementById('order-number-display').textContent = currentOrderNumber;
            switchView('confirmation-view');
        
        } catch (error) {
            console.error("Error al procesar el pedido o guardar el ticket:", error);
            alert("‚ùå Hubo un problema al procesar y enviar el pedido. Por favor, intenta de nuevo.");
        }
    });    
    newOrderBtn.addEventListener('click', resetApp);
    navMenuBtn.addEventListener('click', () => switchView('menu-view'));
    navCartBtn.addEventListener('click', () => switchView('cart-view'));
    categoryBtns.forEach(btn => { btn.addEventListener('click', () => { currentFilter = btn.dataset.category; categoryBtns.forEach(b => { b.classList.remove('bg-yellow-400', 'text-black'); b.classList.add('bg-red-600', 'text-white'); }); btn.classList.add('bg-yellow-400', 'text-black'); btn.classList.remove('bg-red-600', 'text-white'); renderMenu(); }); });
    deliveryTimeNowOption.addEventListener('click', () => { document.querySelectorAll('.time-option').forEach(b => { b.classList.remove('border-yellow-400', 'border-4'); b.classList.add('border-gray-300', 'border-2'); }); deliveryTimeNowOption.classList.add('border-yellow-400', 'border-4'); deliveryTimeNowOption.classList.remove('border-gray-300', 'border-2'); isScheduled = false; scheduleInputContainer.classList.add('hidden'); });
    deliveryTimeScheduleOption.addEventListener('click', () => { document.querySelectorAll('.time-option').forEach(b => { b.classList.remove('border-yellow-400', 'border-4'); b.classList.add('border-gray-300', 'border-2'); }); deliveryTimeScheduleOption.classList.add('border-yellow-400', 'border-4'); deliveryTimeScheduleOption.classList.remove('border-gray-300', 'border-2'); isScheduled = true; scheduleInputContainer.classList.remove('hidden'); checkScheduleInputs(); });
    scheduledDateInput.addEventListener('change', checkScheduleInputs);
    scheduledTimeInput.addEventListener('input', checkScheduleInputs);
    scheduledTimeInput.addEventListener('change', checkScheduleInputs);
    productList.addEventListener('click', (e) => { const btn = e.target.closest('.add-to-cart-btn'); if (btn) { const id = parseInt(btn.dataset.id); addToCart(id); } });
    cartItemsContainer.addEventListener('click', (e) => { const btn = e.target.closest('.quantity-change-btn, .remove-item-btn'); if (!btn) return; const id = parseInt(btn.dataset.id); if (btn.classList.contains('quantity-change-btn')) { const operation = btn.textContent; handleQuantityChange(id, operation); } else if (btn.classList.contains('remove-item-btn')) { removeFromCart(id); } });
    cartItemsContainer.addEventListener('input', (e) => { const input = e.target.closest('.note-input'); if (input) { const id = parseInt(input.dataset.id); updateNote(id, input.value); } });
    customerNameInput.addEventListener('input', (e) => { customerName = e.target.value; });
    customerPhoneInput.addEventListener('input', (e) => { customerPhone = e.target.value; });
    deliveryOptions.addEventListener('click', (e) => { const btn = e.target.closest('.delivery-option'); if (!btn) return; document.querySelectorAll('.delivery-option').forEach(b => { b.classList.remove('border-yellow-400', 'border-4'); b.classList.add('border-gray-300', 'border-2'); }); btn.classList.add('border-yellow-400', 'border-4'); btn.classList.remove('border-gray-300', 'border-2'); selectedDelivery = btn.dataset.value; if (selectedDelivery === 'A Domicilio') { addressInputContainer.classList.remove('hidden'); } else { addressInputContainer.classList.add('hidden'); } });
    addressInput.addEventListener('input', (e) => { deliveryAddress = e.target.value; });
    paymentMethodsContainer.addEventListener('click', (e) => { const btn = e.target.closest('.payment-option'); if (!btn) return; document.querySelectorAll('.payment-option').forEach(b => { b.classList.remove('border-yellow-400', 'border-4'); b.classList.add('border-gray-300', 'border-2'); }); btn.classList.add('border-yellow-400', 'border-4'); btn.classList.remove('border-gray-300', 'border-2'); selectedPayment = btn.dataset.value; if (selectedPayment === 'Nequi' || selectedPayment === 'Bancolombia') { paymentProofNotice.classList.remove('hidden'); } else { paymentProofNotice.classList.add('hidden'); } });

    const initializeApp = async () => {
        document.getElementById('restaurant-name-header').textContent = RESTAURANT_NAME;
        document.getElementById('address-text').textContent = LOCATION_DATA.address;
        
        const encodedAddress = encodeURIComponent(LOCATION_DATA.address);
        // Corrected link for opening in Google Maps app
        openMapsBtn.href = `geo:3.4940402337368077,-76.50136182453736?q=K\'Le√±os - Sabor 100% Valluno`;
        // Corrected iframe URL
        document.getElementById('gmaps-iframe').src = `https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d497.80022739915904!2d-76.50136182453736!3d3.4940402337368077!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x8e30a10038b99d4f%3A0x8017b7164bfb50f4!2sK'Le%C3%B1os%20-%20Sabor%20100%25%20Valluno!5e0!3m2!1ses-419!2sco!4v1760857589673!5m2!1ses-419!2sco?q=...3?q=${encodedAddress}&zoom=17&output=embed`; 

        // ‚úÖ REQ 2 (Bonus): Handle maps link with InAppBrowser for best practice
        openMapsBtn.addEventListener('click', function(e) {
            if (window.cordova && cordova.InAppBrowser) {
                e.preventDefault();
                cordova.InAppBrowser.open(this.href, '_system');
            }
        });

        categoryBtns[0].classList.add('bg-yellow-400', 'text-black');
        categoryBtns[0].classList.remove('bg-red-600', 'text-white');
        
        updateOperatingStatusDisplay();
        setInterval(updateOperatingStatusDisplay, 60000); 

        const today = new Date();
        scheduledDateInput.min = today.toISOString().split('T')[0];

        renderMenu();
        renderCart();
        renderPaymentMethods();
        renderSocialLinks();
        switchView('menu-view');
        handleExternalLinks();
                
    };

    initializeApp();
}

// ‚úÖ REQ 1: Initialization logic detects if it's in Cordova or a browser.
if (window.cordova) {
    // Running inside Cordova wrapper
    document.addEventListener('deviceready', startApp, false);
} else {
    // Running in a standard browser
    document.addEventListener('DOMContentLoaded', startApp, false);
}

</script>

</body>
</html>
