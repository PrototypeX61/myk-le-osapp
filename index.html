<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K‚ÄôLe√±os Sabor 100% Valluno - Pedidos</title>
    
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #ffffff;
            /* Limita el desplazamiento horizontal innecesario */
            overflow: hidden;	
        }
        .view {
            height: 92vh;
            overflow-y: auto; 
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .hidden-view {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
            position: absolute;
            width: 100%;
        }
        .category-scroll::-webkit-scrollbar {
            display: none;
        }
        .category-scroll {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="max-w-lg mx-auto bg-white antialiased">

    <div id="app-container" class="pb-28">

        <div id="menu-view" class="view">
            <header class="sticky top-0 bg-white z-10 border-b-2 border-black p-3 flex items-center justify-between space-x-3">
                <div class="flex items-center space-x-3">
                    <img src="https://static.wixstatic.com/media/777c76_3f3b35a51e8841f78a4f9e65d8cc7604~mv2.png/v1/fill/w_818,h_544,al_c,q_90,usm_0.66_1.00_0.01,enc_avif,quality_auto/777c76_3f3b35a51e8841f78a4f9e65d8cc7604~mv2.png" alt="Logo K'Le√±os" class="w-14 h-auto">
                    <div>
                        <h1 id="restaurant-name-header" class="text-lg font-black text-red-600"></h1>
                        <p class="text-xs font-medium text-gray-700">Promos y 2x1 todos los d√≠as</p>
                    </div>
                </div>
                <button id="location-btn" class="flex items-center space-x-1 bg-gray-100 border border-gray-300 rounded-full py-1 px-3 transform hover:scale-105 transition-transform">
                    <span class="text-xl">üìç</span>
                    <span class="text-xs font-bold">Sedes</span>
                </button>
            </header>

            <div id="status-box-container" class="p-3">
                <div id="operating-status-box" class="p-3 rounded-lg shadow-md flex items-center space-x-3 transition-all duration-300">
                    <span id="status-icon" class="text-2xl"></span>
                    <div>
                        <p id="status-message-main" class="font-bold text-sm"></p>
                        <p id="status-message-secondary" class="text-xs"></p>
                    </div>
                </div>
            </div>
            <section id="filters-section" class="p-3 bg-white">
                <div class="flex overflow-x-auto category-scroll space-x-2 mb-3">
                    <button data-category="all" class="category-btn flex-shrink-0 bg-red-600 text-white font-bold py-1.5 px-3 rounded-full shadow-md text-sm transform hover:scale-105 transition-transform duration-200">Todos</button>
                    <button data-category="Promos" class="category-btn flex-shrink-0 bg-red-600 text-white font-bold py-1.5 px-3 rounded-full shadow-md text-sm transform hover:scale-105 transition-transform duration-200">Promos</button>
                    <button data-category="Hamburguesas" class="category-btn flex-shrink-0 bg-red-600 text-white font-bold py-1.5 px-3 rounded-full shadow-md text-sm transform hover:scale-105 transition-transform duration-200">Hamburguesas</button>
                    <button data-category="Perros Calientes" class="category-btn flex-shrink-0 bg-red-600 text-white font-bold py-1.5 px-3 rounded-full shadow-md text-sm transform hover:scale-105 transition-transform duration-200">Perros</button>
                    <button data-category="Asados" class="category-btn flex-shrink-0 bg-red-600 text-white font-bold py-1.5 px-3 rounded-full shadow-md text-sm transform hover:scale-105 transition-transform duration-200">Asados</button>
                    <button data-category="Fritos" class="category-btn flex-shrink-0 bg-red-600 text-white font-bold py-1.5 px-3 rounded-full shadow-md text-sm transform hover:scale-105 transition-transform duration-200">Fritos</button>
                    <button data-category="Parrillada" class="category-btn flex-shrink-0 bg-red-600 text-white font-bold py-1.5 px-3 rounded-full shadow-md text-sm transform hover:scale-105 transition-transform duration-200">Parrillada</button>
                    <button data-category="Adiciones" class="category-btn flex-shrink-0 bg-red-600 text-white font-bold py-1.5 px-3 rounded-full shadow-md text-sm transform hover:scale-105 transition-transform duration-200">Adiciones</button>
                </div>
                <div id="social-links-container" class="flex justify-center items-center space-x-5"></div>
            </section>

            <main id="product-list" class="p-3 grid grid-cols-1 gap-3"></main>

            <section class="p-6 text-center bg-gray-50 border-t-2 border-b-2 border-red-600 border-l-2 border-r-2 mx-3 rounded-xl shadow-inner my-5">
                <h2 class="text-xl font-black text-red-600 mb-2">üî• ¬°Siempre con Sabor Valluno! üî•</h2>
                <p class="text-gray-700 text-base font-medium">Estamos trabajando para a√±adir m√°s delicias a nuestro men√∫.</p>
                <p class="text-sm text-gray-500 mt-1">¬°Vuelve pronto para probar nuestras nuevas sorpresas!</p>
            </section>
        </div>

        <div id="cart-view" class="view hidden-view">
            <header class="p-3 border-b-2 border-black"><h1 class="text-xl font-black text-red-600 text-center">üõí Tu Pedido</h1></header>
            <section id="cart-items-container" class="p-3 space-y-3"></section>
            <div id="empty-cart-message" class="p-8 text-center text-gray-500 hidden"><p class="text-base">Tu carrito est√° vac√≠o.</p><p class="text-sm">¬°Agrega algo delicioso del men√∫!</p></div>
            <section class="px-3 py-2"><div class="flex justify-between items-center text-lg font-bold border-t-2 border-black pt-3"><span>TOTAL:</span><span id="cart-total" class="text-red-600">$0.00</span></div></section>
            
            <section class="p-3">
                <h2 class="text-lg font-bold text-red-600 mb-2">üë§ Tus Datos</h2>
                <div class="space-y-2">
                    <input type="text" id="customer-name-input" placeholder="Tu nombre completo" class="w-full p-2.5 border-2 border-gray-300 rounded-lg text-sm focus:border-yellow-400 focus:ring-yellow-400" required>
                    <input type="tel" id="customer-phone-input" placeholder="Tu n√∫mero de WhatsApp (ej: 310...)" class="w-full p-2.5 border-2 border-gray-300 rounded-lg text-sm focus:border-yellow-400 focus:ring-yellow-400" required>
                </div>
            </section>
            
            <section id="scheduling-section" class="p-3 border-t-2 border-gray-100">
                <h2 class="text-lg font-bold text-red-600 mb-2">‚è∞ ¬øCu√°ndo lo quieres?</h2>
                <div class="space-y-3">
                    <div id="delivery-time-now-option" class="time-option w-full text-left p-3 border-2 border-gray-300 rounded-lg flex items-center space-x-3 transition-all cursor-pointer border-yellow-400 border-4">
                        <span class="text-xl">üöÄ</span><span class="font-semibold text-sm">Lo quiero AHORA (Entrega tan pronto como sea posible)</span>
                    </div>
                    <div id="delivery-time-schedule-option" class="time-option w-full text-left p-3 border-2 border-gray-300 rounded-lg flex items-center space-x-3 transition-all cursor-pointer">
                        <span class="text-xl">üóìÔ∏è</span><span class="font-semibold text-sm">Programar para despu√©s</span>
                    </div>
                    
                    <div id="schedule-input-container" class="pl-4 hidden space-y-2">
                        <input type="date" id="scheduled-date-input" class="w-full p-2.5 border-2 border-gray-300 rounded-lg text-sm focus:border-yellow-400 focus:ring-yellow-400">
                        <input type="time" id="scheduled-time-input" class="w-full p-2.5 border-2 border-gray-300 rounded-lg text-sm focus:border-yellow-400 focus:ring-yellow-400">
                        <p id="schedule-warning" class="text-xs text-red-500 mt-1 hidden">‚ö†Ô∏è La hora seleccionada est√° fuera de nuestro horario de servicio. Por favor, revisa el horario.</p>
                    </div>
                </div>
            </section>
            <section class="p-3"><h2 class="text-lg font-bold text-red-600 mb-2">üì¶ Tipo de Entrega</h2><div id="delivery-options" class="space-y-2"><button data-value="A Domicilio" class="delivery-option w-full text-left p-3 border-2 border-gray-300 rounded-lg flex items-center space-x-3 transition-all"><span class="text-xl">üè†</span><span class="font-semibold text-sm">A Domicilio</span></button><div id="address-input-container" class="pl-4 hidden"><input type="text" id="address-input" placeholder="Direcci√≥n completa (barrio, apto, etc.)" class="w-full p-2 border-2 border-gray-300 rounded-lg text-sm focus:border-yellow-400 focus:ring-yellow-400"><p class="text-xs text-gray-500 mt-1">Puedes incluir enlaces de Google Maps o Waze.</p></div><button data-value="Para Recoger en Caja" class="delivery-option w-full text-left p-3 border-2 border-gray-300 rounded-lg flex items-center space-x-3 transition-all"><span class="text-xl">ü•°</span><span class="font-semibold text-sm">Para Recoger en Caja</span></button><button data-value="Comer en el Establecimiento" class="delivery-option w-full text-left p-3 border-2 border-gray-300 rounded-lg flex items-center space-x-3 transition-all"><span class="text-xl">üçΩÔ∏è</span><span class="font-semibold text-sm">Comer en el Establecimiento</span></button></div></section>
            <section class="p-3"><h2 class="text-lg font-bold text-red-600 mb-2">üí≥ M√©todo de Pago</h2><div id="payment-methods-container" class="grid grid-cols-2 gap-2"></div><div id="payment-proof-notice" class="mt-3 p-2 bg-yellow-100 border border-yellow-400 text-yellow-800 rounded-lg text-xs hidden"><p>üìé Recuerda enviar tu comprobante de pago v√≠a WhatsApp para validar tu pedido.</p><p class="mt-1 font-bold">‚ö†Ô∏è Para pedidos programados el pago en l√≠nea es obligatorio.</p></div></section>
            <section class="p-3"><button id="send-order-btn" class="w-full bg-green-500 text-white font-bold text-base py-3 px-4 rounded-xl shadow-lg transform hover:scale-105 transition-transform duration-200 flex items-center justify-center space-x-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg><span>Enviar Pedido por WhatsApp</span></button></section>
        </div>

        <div id="confirmation-view" class="view hidden-view p-6 text-center flex flex-col items-center justify-center min-h-screen"><div class="bg-green-100 rounded-full p-3 mb-4"><svg class="w-14 h-14 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></div><h1 class="text-2xl font-black text-green-600 mb-1">¬°Pedido Enviado!</h1><p class="text-gray-600 text-sm mb-5">Tu pedido ha sido recibido y est√° siendo preparado.</p><div class="bg-yellow-400 border-2 border-black text-black font-bold p-3 rounded-lg shadow-lg mb-5 w-full max-w-xs"><p class="text-xs">N√öMERO DE PEDIDO</p><p id="order-number-display" class="text-3xl tracking-widest"></p></div><p class="text-gray-500 text-sm mb-6">Guarda este n√∫mero para consultas.</p><button id="new-order-btn" class="w-full max-w-xs bg-red-600 text-white font-bold py-2.5 px-5 rounded-lg shadow-md transform hover:scale-105 transition-transform duration-200">Hacer otro pedido</button></div>
        
        <div id="location-view" class="view hidden-view">
            <header class="p-3 border-b-2 border-black"><h1 class="text-xl font-black text-red-600 text-center">üìç Nuestras Sedes</h1></header>
            <div class="p-4">
                <div class="bg-white border-2 border-black rounded-lg p-4 shadow-md">
                    <h2 class="font-bold text-lg">Sede Principal - Brisas de los √Ålamos</h2>
                    <p id="address-text" class="text-gray-700 mt-1 mb-4"></p>
                    <div class="grid grid-cols-2 gap-3">
                        <a id="open-maps-btn" href="#" target="_system" class="text-center w-full bg-blue-500 text-white font-bold text-sm py-2.5 px-3 rounded-lg shadow-md hover:bg-blue-600 transition-colors">Abrir en Google Maps</a>
                        <button id="copy-address-btn" class="w-full bg-gray-200 text-black font-bold text-sm py-2.5 px-3 rounded-lg shadow-md hover:bg-gray-300 transition-colors">Copiar Direcci√≥n</button>
                    </div>
                </div>
            </div>
            <div class="px-4 h-96">
                <iframe 
                    id="gmaps-iframe"
                    class="w-full h-full border-2 border-black rounded-lg"
                    loading="lazy"
                    allowfullscreen
                    referrerpolicy="no-referrer-when-downgrade"
                    src="">
                </iframe>
            </div>
        </div>

    </div>

    <footer id="nav-footer" class="fixed bottom-0 left-0 right-0 max-w-lg mx-auto bg-black text-white p-1.5 flex justify-around items-center border-t-2 border-yellow-400"><button id="nav-menu-btn" class="flex-1 text-center py-2 px-3 bg-red-600 rounded-md font-bold mx-1 transition-transform transform hover:scale-105 text-sm">üè† Men√∫</button><button id="nav-cart-btn" class="flex-1 text-center py-2 px-3 bg-yellow-400 text-black rounded-md font-bold mx-1 transition-transform transform hover:scale-105 text-sm">üõí Pedido <span id="cart-count" class="bg-red-600 text-white text-xs font-bold rounded-full px-1.5 py-0.5 ml-1 hidden">0</span></button></footer>

    <canvas id="ticketCanvas" class="hidden"></canvas>


<script>

// Variable para asegurar que el c√≥digo se ejecute una sola vez
let isAppReady = false; 

// --- NUEVAS FUNCIONES DE CORDOVA/PLUGINS (FILE) ---

// Funci√≥n auxiliar para convertir base64 a Blob
const b64toBlob = (b64Data, contentType = '', sliceSize = 512) => {
    const byteCharacters = atob(b64Data);
    const byteArrays = [];

    for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
        const slice = byteCharacters.slice(offset, offset + sliceSize);
        const byteNumbers = new Array(slice.length);
        for (let i = 0; i < slice.length; i++) {
            byteNumbers[i] = slice.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        byteArrays.push(byteArray);
    }
    return new Blob(byteArrays, { type: contentType });
};

const fileError = (e) => {
    console.error("Error en File System:", e.code, e);
    alert('‚ùå Error de permisos de almacenamiento o sistema de archivos. C√≥digo: ' + e.code);
};

// Funci√≥n principal para guardar la imagen del canvas en la galer√≠a/descargas
const saveTicketImage = (dataURL) => {
    // Solo intenta guardar si cordova y el plugin File est√°n disponibles
    if (!window.cordova || !window.resolveLocalFileSystemURL) {
        console.error("Plugins de Cordova (File) no disponibles. Fallback a descarga web.");
        
        // Fallback para navegador web (Descarga directa)
        const link = document.createElement('a');
        link.href = dataURL;
        link.download = `Klenos-Pedido-${currentOrderNumber}.png`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        return; 
    }

    // Usar la ruta de Descargas en Android (Requiere permisos READ/WRITE_EXTERNAL_STORAGE)
    const folder = cordova.file.externalRootDirectory + 'Download/'; 
    const fileName = `Klenos-Pedido-${currentOrderNumber}.png`;

    window.resolveLocalFileSystemURL(folder, (dirEntry) => {
        dirEntry.getFile(fileName, { create: true }, (fileEntry) => {
            const base64Data = dataURL.split(',')[1];
            const blob = b64toBlob(base64Data, 'image/png');

            fileEntry.createWriter((fileWriter) => {
                fileWriter.onwriteend = () => {
                    alert(`‚úÖ Ticket guardado en la carpeta de Descargas: ${fileName}`);
                    console.log('Ticket guardado en:', fileEntry.toURL());
                };
                fileWriter.onerror = (e) => {
                    alert('‚ùå Error al guardar el ticket. Revisa los permisos: ' + e.toString());
                    console.error('Error al guardar el ticket:', e);
                };
                fileWriter.write(blob);
            }, fileError);
        }, fileError);
    }, fileError);
};

// --- FIN NUEVAS FUNCIONES DE CORDOVA/PLUGINS ---

// Funci√≥n principal de inicializaci√≥n que contiene TODA la l√≥gica de la webapp
const initApp = () => {
    if (isAppReady) return;
    isAppReady = true;

    // TODO EL C√ìDIGO ORIGINAL DEL EVENTO DOMContentLoaded COMIENZA AQU√ç:
    
    const RESTAURANT_NAME = "K‚ÄôLe√±os Sabor 100% Valluno";
    const WHATSAPP_NUMBER = "573216350541";
    
    const LOCATION_DATA = {
        address: "Cl. 75a Nte. #2-110, Acopi, Cali, Valle del Cauca, Colombia",
        map_url: "https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d497.80022739915904!2d-76.50136182453736!3d3.4940402337368077!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x8e30a10038b99d4f%3A0x8017b7164bfb50f4!2sK'Le%C3%B1os%20-%20Sabor%20100%25%20Valluno!5e0!3m2!1ses-419!2sco!4v1760857589673!5m2!1ses-419!2sco" 
    };

    const SOCIAL_LINKS = {
        instagram: "https://www.instagram.com/franquiciasvallunas/",
        facebook: "https://www.facebook.com/FranquiciasVallunas/",
        whatsapp: `https://wa.me/573216350541`,
        tiktok: "https://www.tiktok.com/@franquiciasvallunas",
        website: "https://www.xn--kleos-qta.com/"
    };

    const MENU_ITEMS = [
        { id: 1, name: "üî• 2x1 Combinado (Hamburguesa o Perro)", category: "Promos", price: 18.90 },{ id: 2, name: "üçî Hamburguesa Especial", category: "Hamburguesas", price: 10.50 },{ id: 3, name: "üçî Hamburguesa Especial (Tocineta y Queso)", category: "Hamburguesas", price: 13.50 },{ id: 4, name: "üçî Hamb. con Filete de Pollo Apanado", category: "Hamburguesas", price: 15.90 },{ id: 5, name: "üçî Hamburguesa Mixta", category: "Hamburguesas", price: 19.50 },{ id: 6, name: "ü´ì Arepa Burger", category: "Hamburguesas", price: 14.90 },{ id: 7, name: "üå≠ Perro Americano", category: "Perros Calientes", price: 10.50 },{ id: 8, name: "üå≠ Perro Especial Americano", category: "Perros Calientes", price: 13.50 },{ id: 9, name: "üå≠ Perro Americano + Filete de Pollo", category: "Perros Calientes", price: 17.90 },{ id: 10, name: "ü•© Churrasco", category: "Asados", price: 29.50 },{ id: 11, name: "ü•© Carne Asada", category: "Asados", price: 26.90 },{ id: 12, name: "üçó Filete de Pollo a la Parrilla", category: "Asados", price: 25.90 },{ id: 13, name: "üçó Filete de Pollo Gratinado", category: "Asados", price: 27.90 },{ id: 14, name: "üçñ Costillas a la BBQ", category: "Asados", price: 23.50 },{ id: 15, name: "üç¢ Chuzos (Cerdo, Pollo o Costilla) + Papa", category: "Asados", price: 14.90 },{ id: 16, name: "üê∑ Chuleta Valluna (Cerdo o Pollo)", category: "Fritos", price: 25.90 },{ id: 17, name: "üçü Salchipapa Especial", category: "Fritos", price: 10.50 },{ id: 18, name: "üçü Salchipapa con Costilla Ahumada", category: "Fritos", price: 15.90 },{ id: 19, name: "üçü Salchipapa (Costilla + Pollo)", category: "Fritos", price: 25.90 },{ id: 20, name: "üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Salchipapa Especial Familiar", category: "Fritos", price: 45.50 },{ id: 21, name: "üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Salchipapa Familiar con Todo", category: "Fritos", price: 67.90 },{ id: 22, name: "üî• Parrillada o Picada de 4 Carnes", category: "Parrillada", price: 65.90 },{ id: 23, name: "‚ûï Papa a la Francesa", category: "Adiciones", price: 5.00 },{ id: 24, name: "‚ûï Papa Criolla", category: "Adiciones", price: 5.00 },{ id: 25, name: "‚ûï Tocineta o Queso", category: "Adiciones", price: 3.00 },{ id: 26, name: "‚ûï Adici√≥n Carne de Hamburguesa", category: "Adiciones", price: 5.00 },{ id: 27, name: "‚ûï Adici√≥n Filete de Pollo Parrilla", category: "Adiciones", price: 6.90 },{ id: 28, name: "‚ûï Adici√≥n Filete de Pollo Apanado", category: "Adiciones", price: 7.50 }
    ];

    const PAYMENT_METHODS = [ { name: "Efectivo", icon: "üíµ" }, { name: "Nequi", icon: "üí≥" }, { name: "Bancolombia", icon: "üí≥" }];

    // NUEVO: Horario de Operaci√≥n (Domingo=0, Lunes=1, ..., S√°bado=6)
    const OPERATING_HOURS = [
        { day: 0, start: '17:00', end: '23:00', closeMsg: "Hoy a las 11:00 PM" }, // Domingo (5 PM - 11 PM)
        { day: 1, start: null, end: null, closeMsg: "Ma√±ana a las 5:00 PM" },      // Lunes (Cerrado)
        { day: 2, start: '17:00', end: '23:00', closeMsg: "Hoy a las 11:00 PM" }, // Martes (5 PM - 11 PM)
        { day: 3, start: '17:00', end: '23:00', closeMsg: "Hoy a las 11:00 PM" }, // Mi√©rcoles (5 PM - 11 PM)
        { day: 4, start: '17:00', end: '23:00', closeMsg: "Hoy a las 11:00 PM" }, // Jueves (5 PM - 11 PM)
        { day: 5, start: '17:00', end: '24:00', closeMsg: "Hoy a las 12:00 AM" }, // Viernes (5 PM - 12 AM)
        { day: 6, start: '17:00', end: '24:00', closeMsg: "Hoy a las 12:00 AM" }  // S√°bado (5 PM - 12 AM)
    ];

    let cart = [];
    let customerName = "";
    let customerPhone = "";
    let selectedDelivery = null;
    let deliveryAddress = "";
    let selectedPayment = null;
    let currentOrderNumber = null;
    let currentFilter = "all";
    
    // NUEVO: Variables de estado para la programaci√≥n
    let isScheduled = false;

    const menuView = document.getElementById('menu-view');
    const cartView = document.getElementById('cart-view');
    const confirmationView = document.getElementById('confirmation-view');
    const locationView = document.getElementById('location-view');
    const productList = document.getElementById('product-list');
    const cartItemsContainer = document.getElementById('cart-items-container');
    const cartTotalEl = document.getElementById('cart-total');
    const cartCountEl = document.getElementById('cart-count');
    const emptyCartMessage = document.getElementById('empty-cart-message');
    const customerNameInput = document.getElementById('customer-name-input');
    const customerPhoneInput = document.getElementById('customer-phone-input');
    const deliveryOptions = document.getElementById('delivery-options');
    const addressInputContainer = document.getElementById('address-input-container');
    const addressInput = document.getElementById('address-input');
    const paymentMethodsContainer = document.getElementById('payment-methods-container');
    const paymentProofNotice = document.getElementById('payment-proof-notice');
    const sendOrderBtn = document.getElementById('send-order-btn');
    const newOrderBtn = document.getElementById('new-order-btn');
    const locationBtn = document.getElementById('location-btn');
    const copyAddressBtn = document.getElementById('copy-address-btn');
    const navMenuBtn = document.getElementById('nav-menu-btn');
    const navCartBtn = document.getElementById('nav-cart-btn');
    const navFooter = document.getElementById('nav-footer');
    const filtersSection = document.getElementById('filters-section');
    const categoryBtns = document.querySelectorAll('.category-btn');

    // NUEVOS SELECTORES
    const operatingStatusBox = document.getElementById('operating-status-box');
    const statusIcon = document.getElementById('status-icon');
    const statusMessageMain = document.getElementById('status-message-main');
    const statusMessageSecondary = document.getElementById('status-message-secondary');
    
    const deliveryTimeNowOption = document.getElementById('delivery-time-now-option');
    const deliveryTimeScheduleOption = document.getElementById('delivery-time-schedule-option');
    const scheduleInputContainer = document.getElementById('schedule-input-container');
    const scheduledDateInput = document.getElementById('scheduled-date-input');
    const scheduledTimeInput = document.getElementById('scheduled-time-input');
    const scheduleWarning = document.getElementById('schedule-warning');

    // --- NUEVAS FUNCIONES DE FORMATO DE PRECIOS ---

    const formatMenuPrice = (price) => {
        return `$${price.toFixed(1)}K`; 
    };

    const formatRealAmount = (realAmount) => {
        return `$${realAmount.toLocaleString('es-CO', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
    };

    // --- L√ìGICA DE HORARIO DE ATENCI√ìN ---
    
    const getOperatingStatus = (checkTime) => {
        const now = checkTime || new Date();
        const day = now.getDay(); 
        const hours = now.getHours();
        const minutes = now.getMinutes();

        const schedule = OPERATING_HOURS[day];

        // Lunes cerrado
        if (!schedule.start) {
            // Encuentra el pr√≥ximo d√≠a abierto (Martes=2, si hoy es Lunes=1)
            let nextDayIndex = 2; 
            if(day === 6) nextDayIndex = 0; // Si hoy es s√°bado, abre ma√±ana (Domingo)
            const nextOpenDay = new Date(now);
            nextOpenDay.setDate(now.getDate() + (nextDayIndex - day + 7) % 7);
            const nextDayName = nextOpenDay.toLocaleDateString('es-ES', { weekday: 'long' });
            
            return { isOpen: false, status: "En este momento estamos tomando un breve descanso. üò¥", nextOpen: `${nextDayName} a las 5:00 PM` };
        }

        const [startHour, startMinute] = schedule.start.split(':').map(Number);
        const [endHour, endMinute] = schedule.end.split(':').map(Number);
        
        const currentTimeInMinutes = hours * 60 + minutes;
        const startTimeInMinutes = startHour * 60 + startMinute;
        // 24:00 es 1440 minutos (medianoche)
        const endTimeInMinutes = (endHour === 24 ? 24 * 60 : endHour * 60) + endMinute;

        if (currentTimeInMinutes >= startTimeInMinutes && currentTimeInMinutes < endTimeInMinutes) {
            return { isOpen: true, status: "ABIERTO", nextClose: `Cierre: ${schedule.closeMsg}` };
        } else if (currentTimeInMinutes < startTimeInMinutes) {
            return { isOpen: false, status: "En este momento estamos tomando un breve descanso. üò¥", nextOpen: `Hoy a las ${schedule.start.replace(':00', '').replace('17:00', '5:00 PM')}` };
        } else {
            // Cerrado despu√©s del horario de servicio
            const nextDayIndex = (day + 1) % 7;
            const nextOpenDay = new Date(now);
            nextOpenDay.setDate(now.getDate() + 1);
            
            let nextOpen = OPERATING_HOURS[nextDayIndex].start ? nextOpenDay.toLocaleDateString('es-ES', { weekday: 'long' }) + ' a las 5:00 PM' : 'Martes a las 5:00 PM'; // Caso Lunes (Domingo -> Lunes cerrado)
            
            return { isOpen: false, status: "En este momento estamos tomando un breve descanso. üò¥", nextOpen: nextOpen };
        }
    };

    const updateOperatingStatusDisplay = () => {
        const status = getOperatingStatus();
        operatingStatusBox.className = 'p-3 border-2 rounded-xl text-center shadow-lg mx-3 mt-3'; // Reset classes
        
        if (status.isOpen) {
            operatingStatusBox.classList.add('bg-green-100', 'border-2', 'border-green-500');
            statusIcon.textContent = '‚úÖ';
            statusMessageMain.textContent = `¬°Estamos ${status.status} ahora! Haz tu pedido.`;
            statusMessageSecondary.textContent = status.nextClose;
        } else {
            operatingStatusBox.classList.add('bg-yellow-100', 'border-2', 'border-yellow-600');
            statusIcon.textContent = 'üå§Ô∏èüå•Ô∏è‚òÅÔ∏èüåßÔ∏è‚òÅÔ∏èüå•Ô∏èüå§Ô∏è';
            statusMessageMain.textContent = `¬°Hola! ${status.status}`;
            statusMessageSecondary.textContent = `Abrimos ${status.nextOpen}. ¬°A√∫n puedes programar tu pedido para que sea de los primeros! üòâ.`;
        }
    };

    const isScheduledTimeValid = (date, time) => {
        if (!date || !time) return false;
        
        const scheduledDateTime = new Date(`${date}T${time}:00`);
        const scheduledDay = scheduledDateTime.getDay();
        const scheduledHours = scheduledDateTime.getHours();
        const scheduledMinutes = scheduledDateTime.getMinutes();
        
        const schedule = OPERATING_HOURS[scheduledDay];
        
        if (!schedule.start) return false;

        const [startHour, startMinute] = schedule.start.split(':').map(Number);
        const [endHour, endMinute] = schedule.end.split(':').map(Number);
        
        const scheduledTimeInMinutes = scheduledHours * 60 + scheduledMinutes;
        const startTimeInMinutes = startHour * 60 + startMinute;
        const endTimeInMinutes = (endHour === 24 ? 24 * 60 : endHour * 60) + endMinute;

        return scheduledTimeInMinutes >= startTimeInMinutes && scheduledTimeInMinutes < endTimeInMinutes;
    };

    const checkScheduleInputs = () => {
        const date = scheduledDateInput.value;
        const time = scheduledTimeInput.value;
        
        if (isScheduled && date && time) {
            const isValid = isScheduledTimeValid(date, time);
            if (!isValid) {
                scheduleWarning.classList.remove('hidden');
            } else {
                scheduleWarning.classList.add('hidden');
            }
            return isValid;
        }
        
        scheduleWarning.classList.add('hidden');
        return true;
    };
    
    // --- FIN L√ìGICA DE HORARIO DE ATENCI√ìN ---

    const renderMenu = () => {
        productList.innerHTML = '';
        const f = currentFilter === 'all' ? MENU_ITEMS : MENU_ITEMS.filter(i => i.category === currentFilter);
        
        if(f.length === 0){
            productList.innerHTML = `<p class="text-center text-gray-500 col-span-1">No hay productos en esta categor√≠a.</p>`;
            return;
        }

        f.forEach(i => {
            const c = document.createElement('div');
            c.className = "bg-white border-2 border-black rounded-lg p-3 flex justify-between items-center shadow-md";
            c.innerHTML = `
                <div class="flex-1 pr-2">
                    <h3 class="text-base font-bold">${i.name}</h3>
                    <p class="text-gray-800 font-semibold text-sm">${formatMenuPrice(i.price)}</p>
                </div>
                <button data-id="${i.id}" class="add-to-cart-btn bg-yellow-400 text-black font-bold py-1.5 px-3 rounded-full text-sm transform hover:scale-105 transition-transform duration-200">
                    + Agregar
                </button>
            `;
            productList.appendChild(c);
        });
    };

    const addToCart = (productId) => {
        const product = MENU_ITEMS.find(i => i.id == productId);
        if (product) {
            const existingItem = cart.find(item => item.id === product.id);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                cart.push({ ...product, quantity: 1 });
            }
        }
        updateCartDisplay();
    };

    const removeFromCart = (productId) => {
        const itemIndex = cart.findIndex(item => item.id == productId);
        if (itemIndex > -1) {
            cart.splice(itemIndex, 1);
        }
        updateCartDisplay();
    };

    const updateQuantity = (productId, change) => {
        const item = cart.find(item => item.id == productId);
        if (item) {
            item.quantity += change;
            if (item.quantity <= 0) {
                removeFromCart(productId);
            }
        }
        updateCartDisplay();
    };

    const calculateTotal = () => {
        const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        // Multiplicar por 1000 para obtener el valor real en pesos (de $X.XK a $X,000)
        return total * 1000;
    };

    const updateCartDisplay = () => {
        cartItemsContainer.innerHTML = '';
        const total = calculateTotal();
        
        if (cart.length === 0) {
            emptyCartMessage.classList.remove('hidden');
            sendOrderBtn.disabled = true;
            sendOrderBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
            sendOrderBtn.classList.remove('bg-green-500');
        } else {
            emptyCartMessage.classList.add('hidden');
            sendOrderBtn.disabled = false;
            sendOrderBtn.classList.add('bg-green-500');
            sendOrderBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
        }
        
        cartTotalEl.textContent = formatRealAmount(total);
        cartCountEl.textContent = cart.length;
        if (cart.length > 0) {
            cartCountEl.classList.remove('hidden');
        } else {
            cartCountEl.classList.add('hidden');
        }

        cart.forEach(item => {
            const itemTotal = item.price * item.quantity * 1000;
            const c = document.createElement('div');
            c.className = "bg-white border-2 border-black rounded-lg p-3 flex justify-between items-center shadow-sm";
            c.innerHTML = `
                <div class="flex-1 pr-2">
                    <h3 class="text-sm font-bold">${item.name}</h3>
                    <p class="text-gray-700 text-xs">${formatRealAmount(itemTotal)}</p>
                </div>
                <div class="flex items-center space-x-2">
                    <button data-id="${item.id}" data-action="decrease" class="cart-quantity-btn w-6 h-6 bg-red-500 text-white rounded-full text-xs font-bold">-</button>
                    <span class="font-bold text-sm w-4 text-center">${item.quantity}</span>
                    <button data-id="${item.id}" data-action="increase" class="cart-quantity-btn w-6 h-6 bg-green-500 text-white rounded-full text-xs font-bold">+</button>
                </div>
            `;
            cartItemsContainer.appendChild(c);
        });
    };
    
    const renderPaymentMethods = () => {
        paymentMethodsContainer.innerHTML = '';
        PAYMENT_METHODS.forEach(method => {
            const btn = document.createElement('button');
            btn.dataset.value = method.name;
            btn.className = `payment-option w-full text-left p-3 border-2 border-gray-300 rounded-lg flex items-center space-x-3 transition-all ${method.name === 'Efectivo' ? 'border-yellow-400 border-4' : ''}`;
            btn.innerHTML = `<span class="text-xl">${method.icon}</span><span class="font-semibold text-sm">${method.name}</span>`;
            paymentMethodsContainer.appendChild(btn);
        });
        selectedPayment = 'Efectivo'; // Default
    };

    const switchView = (targetViewId) => {
        const views = [menuView, cartView, confirmationView, locationView];
        views.forEach(view => {
            if (view.id === targetViewId) {
                view.classList.remove('hidden-view');
            } else {
                view.classList.add('hidden-view');
            }
        });
        
        // Esconder el footer de navegaci√≥n si estamos en la vista de confirmaci√≥n
        if (targetViewId === 'confirmation-view') {
            navFooter.classList.add('hidden');
            filtersSection.classList.add('hidden');
        } else {
            navFooter.classList.remove('hidden');
            filtersSection.classList.remove('hidden');
        }
        
        // Si regresamos al men√∫, actualizar el estado de apertura
        if (targetViewId === 'menu-view') {
            updateOperatingStatusDisplay();
        }
    };

    const generateOrderNumber = () => {
        const datePart = new Date().toISOString().slice(0, 10).replace(/-/g, '');
        const randomPart = Math.floor(1000 + Math.random() * 9000);
        return `${datePart}-${randomPart}`;
    };

    const validateForm = () => {
        if (cart.length === 0) {
            alert('‚ùå Tu carrito est√° vac√≠o.');
            return false;
        }
        if (!customerNameInput.value || !customerPhoneInput.value) {
            alert('‚ùå Por favor, ingresa tu nombre y n√∫mero de WhatsApp.');
            return false;
        }
        if (!selectedDelivery) {
            alert('‚ùå Por favor, selecciona un tipo de entrega.');
            return false;
        }
        if (selectedDelivery === 'A Domicilio' && !addressInput.value) {
            alert('‚ùå Por favor, ingresa tu direcci√≥n completa.');
            return false;
        }
        if (!selectedPayment) {
            alert('‚ùå Por favor, selecciona un m√©todo de pago.');
            return false;
        }
        if (isScheduled && !checkScheduleInputs()) {
            alert('‚ùå Por favor, revisa y corrige la hora programada.');
            return false;
        }
        return true;
    };
    
    const formatOrderDetails = () => {
        const now = new Date();
        const dateTimeString = isScheduled 
            ? `PROGRAMADO para el ${scheduledDateInput.value} a las ${scheduledTimeInput.value}`
            : `AHORA (${now.toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit' })})`;
        
        let details = `üìù Nuevo Pedido - K‚ÄôLe√±os\n`;
        details += `---------------------------------------\n`;
        details += `*# Pedido*: ${currentOrderNumber}\n`;
        details += `*Cliente*: ${customerNameInput.value}\n`;
        details += `*WhatsApp*: ${customerPhoneInput.value}\n`;
        details += `*Entrega*: ${selectedDelivery}\n`;
        
        if (selectedDelivery === 'A Domicilio') {
            details += `*Direcci√≥n*: ${addressInput.value}\n`;
        }
        details += `*Hora*: ${dateTimeString}\n`;
        details += `*Pago*: ${selectedPayment}\n`;
        details += `---------------------------------------\n`;
        details += `*Productos*:\n`;

        cart.forEach(item => {
            details += `  - ${item.quantity}x ${item.name} (${formatMenuPrice(item.price)} c/u)\n`;
        });

        details += `---------------------------------------\n`;
        details += `*TOTAL A PAGAR*: ${formatRealAmount(calculateTotal())}\n`;
        details += `---------------------------------------\n`;
        details += `¬°Gracias por tu pedido! *#SaborValluno*`;
        
        return details;
    };

    const generateWhatsAppUrl = (orderNumber, total) => {
        const message = encodeURIComponent(formatOrderDetails());
        return `https://wa.me/${WHATSAPP_NUMBER}?text=${message}`;
    };
    
    // --- L√ìGICA DEL CANVAS PARA EL TICKET ---
    const ticketCanvas = document.getElementById('ticketCanvas');

    const renderTicket = (orderNumber) => {
        const ctx = ticketCanvas.getContext('2d');
        
        const width = 500;
        const lineHeight = 30;
        const padding = 20;
        let y = padding;
        
        // Calcular altura din√°mica
        let contentHeight = 180 + (cart.length * lineHeight) + 120;
        
        ticketCanvas.width = width;
        ticketCanvas.height = contentHeight;
        
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, width, contentHeight);

        // Header
        ctx.font = 'bold 32px Poppins';
        ctx.fillStyle = '#C8102E'; // Red
        ctx.textAlign = 'center';
        ctx.fillText(RESTAURANT_NAME, width / 2, y + 20);
        y += 40;
        
        ctx.font = 'bold 18px Poppins';
        ctx.fillStyle = '#000000';
        ctx.fillText('PEDIDO RECIBIDO', width / 2, y + 20);
        y += 30;
        
        // Order Number
        ctx.font = '900 36px Poppins';
        ctx.fillStyle = '#FBBF24'; // Yellow
        ctx.textAlign = 'center';
        ctx.fillText(orderNumber, width / 2, y + 40);
        y += 60;
        
        // Items Header
        ctx.font = 'bold 16px Poppins';
        ctx.fillStyle = '#000000';
        ctx.textAlign = 'left';
        ctx.fillText('CANT.', padding, y + 10);
        ctx.textAlign = 'left';
        ctx.fillText('PRODUCTO', padding + 80, y + 10);
        ctx.textAlign = 'right';
        ctx.fillText('TOTAL', width - padding, y + 10);
        y += 20;

        // Separator
        ctx.strokeStyle = '#000000';
        ctx.beginPath();
        ctx.moveTo(padding, y + 5);
        ctx.lineTo(width - padding, y + 5);
        ctx.stroke();
        y += 10;
        
        // Items List
        ctx.font = '16px Poppins';
        cart.forEach(item => {
            const itemTotal = item.price * item.quantity * 1000;
            
            ctx.fillStyle = '#000000';
            ctx.textAlign = 'left';
            ctx.fillText(item.quantity, padding, y + 10);
            
            ctx.fillText(item.name, padding + 80, y + 10);
            
            ctx.textAlign = 'right';
            ctx.fillText(formatRealAmount(itemTotal), width - padding, y + 10);
            y += lineHeight;
        });

        // Separator
        y += 5;
        ctx.beginPath();
        ctx.moveTo(padding, y + 5);
        ctx.lineTo(width - padding, y + 5);
        ctx.stroke();
        y += 10;
        
        // Total
        const total = calculateTotal();
        ctx.font = 'bold 20px Poppins';
        ctx.fillStyle = '#C8102E'; // Red
        ctx.textAlign = 'left';
        ctx.fillText('TOTAL:', padding, y + 20);
        ctx.textAlign = 'right';
        ctx.fillText(formatRealAmount(total), width - padding, y + 20);
        y += 40;
        
        // Footer
        ctx.font = '14px Poppins';
        ctx.fillStyle = '#6B7280'; // Gray
        ctx.textAlign = 'center';
        ctx.fillText('¬°Te contactaremos pronto para confirmar la entrega!', width / 2, y + 20);
    };

    // --- EVENT LISTENERS ---

    // Initial load setup
    document.getElementById('restaurant-name-header').textContent = RESTAURANT_NAME;
    document.getElementById('address-text').textContent = LOCATION_DATA.address;
    document.getElementById('gmaps-iframe').src = `https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d1!2d-76.541416!3d3.479573!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x0%3A0x0!2zM8KwMjgnNDYuNSJOIDc2wrMyNScrMTQuMSJX!5e0!3m2!1ses!2sco!4v1678899876543!5m2!1ses!2sco`;

    renderMenu();
    updateCartDisplay();
    renderPaymentMethods();
    updateOperatingStatusDisplay();
    
    // Configurar la fecha m√≠nima para el calendario (hoy)
    const today = new Date().toISOString().split('T')[0];
    scheduledDateInput.setAttribute('min', today);


    // Navigation
    navMenuBtn.addEventListener('click', () => switchView('menu-view'));
    navCartBtn.addEventListener('click', () => switchView('cart-view'));
    locationBtn.addEventListener('click', () => switchView('location-view'));
    newOrderBtn.addEventListener('click', () => switchView('menu-view'));

    // Cart actions
    productList.addEventListener('click', (e) => {
        const btn = e.target.closest('.add-to-cart-btn');
        if (btn) {
            addToCart(btn.dataset.id);
        }
    });

    cartItemsContainer.addEventListener('click', (e) => {
        const btn = e.target.closest('.cart-quantity-btn');
        if (btn) {
            const action = btn.dataset.action;
            const id = btn.dataset.id;
            if (action === 'increase') {
                updateQuantity(id, 1);
            } else if (action === 'decrease') {
                updateQuantity(id, -1);
            }
        }
    });

    // Filters
    categoryBtns.forEach(btn => {
        btn.addEventListener('click', (e) => {
            currentFilter = btn.dataset.category;
            
            // Highlight active button
            categoryBtns.forEach(b => {
                b.classList.remove('bg-yellow-400', 'text-black');
                b.classList.add('bg-red-600', 'text-white');
            });
            btn.classList.add('bg-yellow-400', 'text-black');
            btn.classList.remove('bg-red-600', 'text-white');
            
            renderMenu();
        });
    });
    
    // Initial highlight for 'all'
    document.querySelector('.category-btn[data-category="all"]').classList.remove('bg-red-600', 'text-white');
    document.querySelector('.category-btn[data-category="all"]').classList.add('bg-yellow-400', 'text-black');


    // Delivery Type
    deliveryOptions.addEventListener('click', (e) => {
        const btn = e.target.closest('.delivery-option');
        if (!btn) return;

        document.querySelectorAll('.delivery-option').forEach(b => {
            b.classList.remove('border-yellow-400', 'border-4');
            b.classList.add('border-gray-300', 'border-2');
        });

        btn.classList.add('border-yellow-400', 'border-4');
        btn.classList.remove('border-gray-300', 'border-2');

        selectedDelivery = btn.dataset.value;

        if (selectedDelivery === 'A Domicilio') {
            addressInputContainer.classList.remove('hidden');
        } else {
            addressInputContainer.classList.add('hidden');
        }
    });

    addressInput.addEventListener('input', (e) => {
        deliveryAddress = e.target.value;
    });

    // Payment Method
    paymentMethodsContainer.addEventListener('click', (e) => {
        const btn = e.target.closest('.payment-option');
        if (!btn) return;

        document.querySelectorAll('.payment-option').forEach(b => {
            b.classList.remove('border-yellow-400', 'border-4');
            b.classList.add('border-gray-300', 'border-2');
        });

        btn.classList.add('border-yellow-400', 'border-4');
        btn.classList.remove('border-gray-300', 'border-2');
        
        selectedPayment = btn.dataset.value;

        if (selectedPayment === 'Nequi' || selectedPayment === 'Bancolombia') {
            paymentProofNotice.classList.remove('hidden');
        } else {
            paymentProofNotice.classList.add('hidden');
        }
    });
    
    // Delivery Time Scheduling
    deliveryTimeNowOption.addEventListener('click', () => {
        isScheduled = false;
        deliveryTimeNowOption.classList.add('border-yellow-400', 'border-4');
        deliveryTimeNowOption.classList.remove('border-gray-300', 'border-2');
        deliveryTimeScheduleOption.classList.remove('border-yellow-400', 'border-4');
        deliveryTimeScheduleOption.classList.add('border-gray-300', 'border-2');
        scheduleInputContainer.classList.add('hidden');
        paymentProofNotice.classList.add('hidden');
    });

    deliveryTimeScheduleOption.addEventListener('click', () => {
        isScheduled = true;
        deliveryTimeScheduleOption.classList.add('border-yellow-400', 'border-4');
        deliveryTimeScheduleOption.classList.remove('border-gray-300', 'border-2');
        deliveryTimeNowOption.classList.remove('border-yellow-400', 'border-4');
        deliveryTimeNowOption.classList.add('border-gray-300', 'border-2');
        scheduleInputContainer.classList.remove('hidden');
        paymentProofNotice.classList.remove('hidden'); // Se hace visible para pedidos programados
        checkScheduleInputs();
    });

    scheduledDateInput.addEventListener('change', checkScheduleInputs);
    scheduledTimeInput.addEventListener('change', checkScheduleInputs);

    // Copy Address Button
    copyAddressBtn.addEventListener('click', async () => {
        try {
            // Usa Cordova Clipboard API si est√° disponible, sino usa Clipboard Web API
            if (window.cordova && cordova.plugins && cordova.plugins.clipboard) {
                cordova.plugins.clipboard.copy(LOCATION_DATA.address);
            } else if (navigator.clipboard) {
                await navigator.clipboard.writeText(LOCATION_DATA.address);
            } else {
                throw new Error('Clipboard API no disponible');
            }
            alert('‚úÖ Direcci√≥n copiada al portapapeles!');
        } catch (err) {
            console.error('Error al copiar:', err);
            alert('‚ùå Error al copiar la direcci√≥n.');
        }
    });


    // --- BOT√ìN FINAL DE ENV√çO (CORREGIDO PARA PLUGINS) ---
    sendOrderBtn.addEventListener('click', () => {
        if (!validateForm()) return;

        currentOrderNumber = generateOrderNumber();
        renderTicket(currentOrderNumber);
        
        const dataURL = ticketCanvas.toDataURL('image/png');
        const whatsappUrl = generateWhatsAppUrl(currentOrderNumber, cartTotal);

        // 1. Guardar el ticket (File Plugin)
        saveTicketImage(dataURL); // Esta funci√≥n incluye fallback para descarga web si los plugins fallan

        // 2. Abrir WhatsApp (InAppBrowser Plugin)
        if (window.cordova && window.cordova.InAppBrowser) {
            // Usar InAppBrowser para forzar la apertura de la app WhatsApp
            cordova.InAppBrowser.open(whatsappUrl, '_system');
        } else {
            // Fallback para navegador web
            window.open(whatsappUrl, '_blank');
        }

        // Mostrar confirmaci√≥n
        document.getElementById('order-number-display').textContent = currentOrderNumber;
        customerName = customerNameInput.value;
        customerPhone = customerPhoneInput.value;
        
        switchView('confirmation-view');
        cart = []; // Vaciar carrito
        updateCartDisplay(); // Actualizar interfaz
    });
    // --- FIN BOT√ìN FINAL DE ENV√çO ---

}; // Fin de initApp

// 1. Evento principal de Cordova (mobile): Los plugins est√°n listos
document.addEventListener('deviceready', initApp);

// 2. Fallback para navegador web (PC): Si Cordova no se detecta en 3 segundos
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        if (!isAppReady) {
            console.warn("Cordova no detectado. Inicializando en modo navegador.");
            initApp();
        }
    }, 3000);
});

</script>

</body>
</html>
